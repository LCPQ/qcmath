(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    114052,       2544]
NotebookOptionsPosition[    113218,       2521]
NotebookOutlinePosition[    113643,       2538]
CellTagsIndexPosition[    113600,       2535]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"G0T0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
   "\n", "  ", "\n", "  ", 
   RowBox[{"Module", "[", "\n", "    ", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"regularizermethod", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Option", " ", "to", " ", "choose", " ", "the", " ", "regularizer", 
         " ", "of", " ", "quasiparticle", " ", "equations"}], " ", "*)"}], 
       "\n", "     ", "s", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Value", " ", "of", " ", "the", " ", "regularizer", " ", 
         "parameter"}], " ", "*)"}], "\n", "     ", "\[Eta]", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Value", " ", "of", " ", "the", " ", "broadening", " ", "imaginary", 
         " ", "constant"}], " ", "*)"}], "\n", "     ", "lin", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"Don", "'"}], "t", " ", "solve", " ", "the", " ", 
         "nonlinear", " ", "qp", " ", "equation", " ", "and", " ", "use", " ",
          "approximate", " ", "linearized", " ", "qp", " ", "energies"}], " ",
         "*)"}], "\n", "     ", "regularizerorbital", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Regularizer", " ", "for", " ", "the", " ", "static", " ", "part"}], 
        " ", "*)"}], "\n", "     ", "regularizerselfenergy", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Regularizer", " ", "for", " ", "the", " ", "dynamic", " ", "part"}], 
        " ", "*)"}], "\n", "     ", "TDA", ",", "\n", "     ", "TDAT", ",", 
       "\n", "     ", "outputsG0T0"}], "\n", "     ", "}"}], ",", "\n", 
     "    ", "\n", "    ", 
     RowBox[{
      RowBox[{"regularizermethod", " ", "=", " ", 
       RowBox[{"options", "[", 
        RowBox[{"[", "\"\<MBPT_regularizer_methods\>\"", "]"}], "]"}]}], ";", 
      "\n", "    ", 
      RowBox[{"s", " ", "=", " ", 
       RowBox[{"options", "[", 
        RowBox[{"[", "\"\<MBPT_regularizer_value\>\"", "]"}], "]"}]}], ";", 
      "\n", "    ", 
      RowBox[{"lin", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<linearized\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", "    ", 
      RowBox[{"\[Eta]", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<\[Eta]\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"TDA", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"TDAT", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA_T\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", "\n", "   ", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"TDA", "\[Equal]", "True"}], ",", 
        RowBox[{
        "PrintTemporary", "[", 
         "\"\<Tamm-Dancoff approximation activated !\>\"", "]"}]}], "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"TDAT", "\[Equal]", "True"}], ",", 
        RowBox[{
        "PrintTemporary", "[", 
         "\"\<Tamm-Dancoff approximation for screening !\>\"", "]"}]}], "]"}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{
       RowBox[{"regularizerorbital", "[", "\[CapitalDelta]_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", "\n", "    ", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
            RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
            RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"Exp", "[", 
              RowBox[{
               RowBox[{"-", "2"}], "s", " ", 
               SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}], "]"}]}], 
           "]"}], ";"}]}], "\n", "    ", "]"}]}], ";", "\n", "\n", "    ", 
      RowBox[{
       RowBox[{"regularizerselfenergy", "[", "\[CapitalDelta]_", "]"}], ":=", 
       
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", "\n", "    ", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
            RowBox[{"Return", "[", "1", "]"}]}], "]"}], ";", "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"1", " ", "-", " ", 
              RowBox[{"Exp", "[", 
               RowBox[{
                RowBox[{"-", "2"}], "s", " ", 
                SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
           "]"}], ";", "\n", "    ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"1", " ", "-", " ", 
              RowBox[{"Exp", "[", 
               RowBox[{
                RowBox[{"-", "2"}], "s", " ", 
                SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
           "]"}], ";"}]}], "\n", "    ", "]"}]}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"options", "[", "\"\<spinorbital\>\"", "]"}], "==", "True"}],
         ",", "\n", "\t\t", 
        RowBox[{"outputsG0T0", "=", 
         RowBox[{"spinorbG0T0", "[", 
          RowBox[{
          "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]", ",", "ERI", ",", 
           "ENuc", ",", "ERHF", ",", "TDA", ",", "TDAT", ",", "\[Eta]", ",", 
           "verbose", ",", "lin", ",", "s", ",", "options", ",", 
           "regularizerorbital", ",", "regularizerselfenergy"}], "]"}]}], 
        "\n", "\t", ",", 
        RowBox[{"(*", 
         RowBox[{"else", " ", "go", " ", "to", " ", "spatial"}], " ", "*)"}], 
        "\n", "\t\t", 
        RowBox[{"outputsG0T0", "=", 
         RowBox[{"spatialorbG0T0", "[", 
          RowBox[{
          "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]", ",", "ERI", ",", 
           "ENuc", ",", "ERHF", ",", "TDA", ",", "TDAT", ",", "\[Eta]", ",", 
           "verbose", ",", "lin", ",", "s", ",", "options", ",", 
           "regularizerorbital", ",", "regularizerselfenergy"}], "]"}]}]}], 
       "\n", "\t", "]"}], ";", "\n", "\t", "\n", "\t", 
      RowBox[{"Return", "[", "outputsG0T0", "]"}], ";"}]}], "\n", "\t", "\n", 
    "]"}]}], ";"}], "\n", 
 RowBox[{"   "}]}], "Code",
 CellChangeTimes->{{3.842408058710023*^9, 3.842408073224633*^9}, {
   3.8424082299289913`*^9, 3.842408233937099*^9}, {3.84240833225532*^9, 
   3.842408532892281*^9}, {3.842408688661069*^9, 3.842408715469098*^9}, {
   3.84241056806275*^9, 3.8424105969321404`*^9}, {3.842410653168235*^9, 
   3.842410857758375*^9}, {3.8424110545209513`*^9, 3.842411073531735*^9}, {
   3.842411247938425*^9, 3.842411269389552*^9}, {3.842411301460087*^9, 
   3.8424113280318747`*^9}, {3.842411390446432*^9, 3.842411420584807*^9}, {
   3.842411626283288*^9, 3.842411641567184*^9}, {3.842411758893763*^9, 
   3.842411792432971*^9}, {3.842500705503829*^9, 3.842500751308353*^9}, {
   3.842500836361291*^9, 3.842500853576702*^9}, {3.84250104231334*^9, 
   3.842501059176137*^9}, {3.842501238140094*^9, 3.842501245353696*^9}, {
   3.842501693228163*^9, 3.8425017034879923`*^9}, {3.842502433416733*^9, 
   3.8425024611883593`*^9}, {3.842502630515695*^9, 3.842502657652898*^9}, {
   3.842502881404231*^9, 3.84250290280787*^9}, {3.842503422266075*^9, 
   3.842503428434497*^9}, {3.842503529111493*^9, 3.84250353474297*^9}, {
   3.842503605855461*^9, 3.842503613728839*^9}, {3.8425036775180397`*^9, 
   3.842503688740879*^9}, {3.842503779378091*^9, 3.842503928754552*^9}, {
   3.8425040738903637`*^9, 3.842504178062727*^9}, {3.842690557173007*^9, 
   3.8426905632376547`*^9}, {3.8426908400482187`*^9, 3.842690873079913*^9}, {
   3.8426909080449753`*^9, 3.842691084670616*^9}, 3.8426911460967712`*^9, {
   3.8426915232859373`*^9, 3.8426915345632668`*^9}, {3.842691963418445*^9, 
   3.842691979746295*^9}, {3.842692068497138*^9, 3.84269208751083*^9}, {
   3.842693216101647*^9, 3.8426932351343193`*^9}, {3.8429457142573977`*^9, 
   3.842945717617219*^9}, {3.8429464656599197`*^9, 3.8429464690626507`*^9}, {
   3.8429465221396933`*^9, 3.842946529229496*^9}, {3.842946888513489*^9, 
   3.8429469866102257`*^9}, {3.842947418628124*^9, 3.842947424594594*^9}, {
   3.842947474184067*^9, 3.8429474790769157`*^9}, {3.84294751325834*^9, 
   3.842947522727906*^9}, {3.8429476652817163`*^9, 3.842947694331163*^9}, {
   3.842947818190649*^9, 3.842947824560898*^9}, {3.842947898364048*^9, 
   3.842947907973803*^9}, {3.842948083684971*^9, 3.842948090575492*^9}, {
   3.8429482893562*^9, 3.842948322927093*^9}, 3.842950749725966*^9, {
   3.8430977586560802`*^9, 3.843097763986755*^9}, {3.8430979777941732`*^9, 
   3.843097986186965*^9}, 3.843098070877219*^9, {3.843099928272254*^9, 
   3.843099948465023*^9}, {3.84310067004431*^9, 3.8431006750631657`*^9}, {
   3.843102841929281*^9, 3.8431028643341217`*^9}, {3.843103754950145*^9, 
   3.8431037574184847`*^9}, {3.843103795820319*^9, 3.8431038270970488`*^9}, {
   3.843111764467041*^9, 3.8431117781740847`*^9}, {3.843113330895084*^9, 
   3.8431133849213657`*^9}, {3.8431164770469*^9, 3.843116494894511*^9}, 
   3.8431166371249037`*^9, {3.843117067820505*^9, 3.843117077601493*^9}, {
   3.843117239406501*^9, 3.843117242425406*^9}, {3.84370649231754*^9, 
   3.8437065078229094`*^9}, {3.8437065884360847`*^9, 3.843706606700554*^9}, {
   3.843706638646991*^9, 3.843706640356533*^9}, {3.843706741614674*^9, 
   3.84370675366713*^9}, {3.8437070145577927`*^9, 3.843707020314501*^9}, {
   3.8437070887755527`*^9, 3.843707156198683*^9}, {3.8437072625777683`*^9, 
   3.843707264220161*^9}, 3.843707418699622*^9, {3.8437074727322817`*^9, 
   3.843707507867373*^9}, {3.843708317460191*^9, 3.843708318965515*^9}, 
   3.8437084587377367`*^9, {3.843817027901298*^9, 3.843817034601162*^9}, {
   3.8439205033966103`*^9, 3.843920504905941*^9}, {3.843920538279956*^9, 
   3.843920558105171*^9}, {3.843920598430665*^9, 3.843920607012617*^9}, 
   3.8439207035814257`*^9, {3.843920778157654*^9, 3.8439208249236383`*^9}, {
   3.843920945852683*^9, 3.8439209462460327`*^9}, {3.843921014851842*^9, 
   3.843921017257218*^9}, {3.8441393255969257`*^9, 3.844139326020208*^9}, {
   3.844140073668932*^9, 3.8441400758813343`*^9}, {3.844140995498438*^9, 
   3.84414100036455*^9}, {3.844141801755087*^9, 3.8441418019389677`*^9}, {
   3.844142174111198*^9, 3.8441421930695887`*^9}, {3.8441422594286747`*^9, 
   3.84414231807467*^9}, {3.844142360260326*^9, 3.8441423727775373`*^9}, {
   3.844142445056593*^9, 3.844142455150838*^9}, {3.844142488133336*^9, 
   3.8441425218718843`*^9}, {3.844142553998912*^9, 3.8441425613087254`*^9}, {
   3.8441432442867327`*^9, 3.844143288834347*^9}, {3.8441433741695633`*^9, 
   3.844143375383136*^9}, {3.844143466651594*^9, 3.84414346696525*^9}, {
   3.84414350583311*^9, 3.844143505988749*^9}, {3.8441435414748774`*^9, 
   3.8441435487593317`*^9}, {3.844143672048736*^9, 3.844143700942975*^9}, {
   3.844144067347769*^9, 3.844144074108087*^9}, {3.844144345891025*^9, 
   3.844144346039876*^9}, {3.844144500257166*^9, 3.844144505822361*^9}, {
   3.844144543643014*^9, 3.844144545525663*^9}, {3.844144975933425*^9, 
   3.8441449823330708`*^9}, {3.8441450251589622`*^9, 3.844145036507162*^9}, {
   3.844145367346808*^9, 3.8441453768988247`*^9}, {3.8441515758954906`*^9, 
   3.844151576039871*^9}, {3.844151746325861*^9, 3.844151746624578*^9}, {
   3.844151795855426*^9, 3.8441517975089283`*^9}, {3.844151897828936*^9, 
   3.844151912258297*^9}, {3.844152477654252*^9, 3.844152481496591*^9}, {
   3.84415327806634*^9, 3.844153283205162*^9}, {3.844153321577631*^9, 
   3.844153338944965*^9}, {3.84415380021593*^9, 3.844153804697085*^9}, {
   3.844153835503563*^9, 3.844153838079167*^9}, {3.844936309268704*^9, 
   3.844936319514324*^9}, {3.8449366525224657`*^9, 3.8449366568333273`*^9}, {
   3.844940536810768*^9, 3.844940592852908*^9}, {3.844940663711804*^9, 
   3.8449406972813263`*^9}, {3.844940739490336*^9, 3.8449407573321037`*^9}, {
   3.844940797938547*^9, 3.844940838933372*^9}, {3.844940883004136*^9, 
   3.844940895920888*^9}, {3.8449412591374187`*^9, 3.844941259772201*^9}, {
   3.844941375139073*^9, 3.844941375608473*^9}, {3.847856543178671*^9, 
   3.847856562103387*^9}, {3.848719045417695*^9, 3.848719108013894*^9}, {
   3.848719971912504*^9, 3.848720031308422*^9}, {3.848970402438033*^9, 
   3.8489704268692837`*^9}, {3.849578890919074*^9, 3.84957889849938*^9}, 
   3.8495789328177156`*^9, {3.84957909776898*^9, 3.849579104096321*^9}, {
   3.84957932347873*^9, 3.849579329125771*^9}, {3.849579586293133*^9, 
   3.849579588965783*^9}, {3.8495812228285933`*^9, 3.849581234443884*^9}, {
   3.849584162502499*^9, 3.8495841629390173`*^9}, 3.849836884338806*^9, {
   3.84983752652456*^9, 3.8498375302543163`*^9}, {3.849837585433915*^9, 
   3.849837602428093*^9}, {3.849837632563746*^9, 3.849837637528343*^9}, {
   3.8498376741410313`*^9, 3.849837710674047*^9}, {3.849837948588913*^9, 
   3.8498379524124947`*^9}, {3.849838051587928*^9, 3.849838164760993*^9}, {
   3.849838336926445*^9, 3.849838341438114*^9}, 3.849838568175597*^9, {
   3.850210290813127*^9, 3.850210300078229*^9}, {3.850210451647662*^9, 
   3.8502104524872627`*^9}, 3.8502111793609037`*^9, 3.850222741402637*^9, {
   3.851073609703409*^9, 3.851073670531787*^9}, {3.851073884101906*^9, 
   3.8510738844642153`*^9}, {3.8510739664475317`*^9, 
   3.8510741521011667`*^9}, {3.872914333982317*^9, 3.872914483094529*^9}, {
   3.872914519897031*^9, 3.872914550813428*^9}, 3.872914592848044*^9, {
   3.872914644027671*^9, 3.8729146706151342`*^9}, {3.872914715492736*^9, 
   3.87291479211112*^9}, {3.872916041817358*^9, 3.872916052779881*^9}, {
   3.872916144611116*^9, 3.872916197377199*^9}, {3.872916239456299*^9, 
   3.8729162491089582`*^9}, {3.872916378761599*^9, 3.872916401619483*^9}, {
   3.8729164560603523`*^9, 3.87291646404652*^9}, {3.8729166222450323`*^9, 
   3.8729166252376137`*^9}, {3.872920928458952*^9, 3.872920933010503*^9}, 
   3.872921150806493*^9, 3.872921238814739*^9, {3.872921348923752*^9, 
   3.8729213565415277`*^9}, {3.8729221131405*^9, 3.872922123658842*^9}, {
   3.872922200999546*^9, 3.872922201099944*^9}, {3.8729222512126207`*^9, 
   3.8729222874693747`*^9}, {3.872922542390093*^9, 3.872922545362884*^9}, {
   3.872932372875054*^9, 3.8729323986549187`*^9}, 3.873165275160346*^9, {
   3.873165432357113*^9, 3.873165505446373*^9}, {3.873165881427865*^9, 
   3.873165897933873*^9}, {3.873165935679578*^9, 3.873165937607025*^9}, 
   3.87316598181212*^9, {3.873166076965251*^9, 3.8731660780495577`*^9}, {
   3.873166144650009*^9, 3.873166150344255*^9}, {3.87316622796843*^9, 
   3.8731662280836077`*^9}, {3.873166356782386*^9, 3.873166363727681*^9}, {
   3.873166445309019*^9, 3.873166486587834*^9}, {3.873166658449081*^9, 
   3.873166673688611*^9}, {3.873166958307513*^9, 3.873166963176115*^9}, {
   3.8731670032599792`*^9, 3.87316705737463*^9}, {3.873167103293621*^9, 
   3.8731671268251343`*^9}, 3.87316736132838*^9, {3.873167392612747*^9, 
   3.8731674156110163`*^9}, 3.873167868910369*^9, {3.873167908112262*^9, 
   3.873167935101531*^9}, {3.8731697738771343`*^9, 3.873169778640568*^9}, {
   3.873170498176477*^9, 3.87317053194741*^9}, 3.873170579254678*^9, {
   3.873170823941083*^9, 3.873170849310759*^9}, {3.87317103056846*^9, 
   3.873171117717764*^9}, {3.873171151685638*^9, 3.873171157871325*^9}, 
   3.873171288009253*^9, {3.873171570550995*^9, 3.8731716087500753`*^9}, {
   3.873171643059359*^9, 3.873171645096191*^9}, {3.873172119769692*^9, 
   3.873172123176277*^9}, {3.87318871036241*^9, 3.873188716505144*^9}, 
   3.8731897531473618`*^9, {3.87325008107928*^9, 3.873250090308908*^9}, {
   3.8732503998731203`*^9, 3.8732504501142282`*^9}, {3.87325085296793*^9, 
   3.873250853049799*^9}, {3.873251266483685*^9, 3.8732512886943893`*^9}, {
   3.873251353312189*^9, 3.8732513649219007`*^9}, {3.8732514389361877`*^9, 
   3.873251460543522*^9}, 3.8732517278477707`*^9, {3.8732527314239388`*^9, 
   3.873252733079536*^9}, {3.873252778503289*^9, 3.873252781175029*^9}, {
   3.873252926589036*^9, 3.873252928787332*^9}, 3.873253821435473*^9, {
   3.873253982916333*^9, 3.873253997660596*^9}, {3.873254247528339*^9, 
   3.873254264610729*^9}, 3.873255163327273*^9, {3.87325530750315*^9, 
   3.873255362038562*^9}, {3.873269090905445*^9, 3.873269106129026*^9}, 
   3.873269508397122*^9, {3.873269731881708*^9, 3.873269790203045*^9}, {
   3.873270708794861*^9, 3.873270723731462*^9}, {3.873270757914278*^9, 
   3.8732707995528*^9}, {3.873270896948917*^9, 3.873270913149129*^9}, {
   3.873271069808783*^9, 3.873271080349304*^9}, 3.873271646101283*^9, 
   3.873272851816174*^9, {3.8737677171410837`*^9, 3.873768042510515*^9}, {
   3.873768073211471*^9, 3.87376816020292*^9}, {3.873768296325691*^9, 
   3.873768466501519*^9}, {3.8737694472679663`*^9, 3.8737694619889507`*^9}, {
   3.8737697233483353`*^9, 3.873769746601453*^9}, {3.873769816239848*^9, 
   3.873769824087607*^9}, {3.8737700004708643`*^9, 3.8737700010101347`*^9}, {
   3.8737700314235983`*^9, 3.87377010474096*^9}, {3.873770863580599*^9, 
   3.87377087717176*^9}, {3.8737709768014*^9, 3.8737709985511103`*^9}, {
   3.87377127711065*^9, 3.8737712777883787`*^9}, {3.873771342883062*^9, 
   3.8737713434932013`*^9}, {3.873771436213634*^9, 3.873771484377223*^9}, {
   3.873771759487687*^9, 3.873771765111912*^9}, {3.8737718066280193`*^9, 
   3.873771850062908*^9}, {3.873772137460127*^9, 3.873772147709845*^9}, 
   3.8737721872624617`*^9, {3.873772475430916*^9, 3.873772478533574*^9}, {
   3.873772716812414*^9, 3.873772744489726*^9}, 3.8737736465617847`*^9, {
   3.873774012985416*^9, 3.873774022789996*^9}, {3.873774068061812*^9, 
   3.873774068161379*^9}, {3.873774980819726*^9, 3.873774982037683*^9}, {
   3.873775017775943*^9, 3.8737750211620903`*^9}, {3.8737751373578176`*^9, 
   3.873775156357432*^9}, {3.873775198392251*^9, 3.87377519994447*^9}, {
   3.873775246174*^9, 3.873775250545064*^9}, {3.8737753062096853`*^9, 
   3.873775311623809*^9}, {3.873776276493643*^9, 3.8737763044310713`*^9}, {
   3.873776344780167*^9, 3.87377635060985*^9}, {3.873776445290113*^9, 
   3.8737764801637087`*^9}, {3.8737784851006927`*^9, 
   3.8737784921038027`*^9}, {3.8737787685850973`*^9, 3.873778768706162*^9}, 
   3.873778835447373*^9, {3.873779375590027*^9, 3.873779388025141*^9}, 
   3.8737798768869543`*^9, {3.873780165052902*^9, 3.873780209416925*^9}, {
   3.87378500016438*^9, 3.873785011826221*^9}, 3.873785517064855*^9, {
   3.873785908227264*^9, 3.873785912592318*^9}, 3.87378594607084*^9, {
   3.873786414300273*^9, 3.873786428425559*^9}, 3.8737864930028267`*^9, {
   3.87379212999855*^9, 3.873792138398794*^9}, {3.873792295701137*^9, 
   3.873792299914764*^9}, 3.873792465255506*^9, {3.873797844409636*^9, 
   3.8737978494723063`*^9}, {3.873808252950965*^9, 3.873808260964348*^9}, {
   3.873808345930327*^9, 3.8738083475344276`*^9}, {3.873808385999998*^9, 
   3.873808392215659*^9}, {3.8738084432596407`*^9, 3.873808460976536*^9}, {
   3.873808548415558*^9, 3.873808548769425*^9}, {3.873808603815436*^9, 
   3.8738086177531433`*^9}, {3.873808690491897*^9, 3.873808701944471*^9}, {
   3.8738087339663973`*^9, 3.873808738482594*^9}, {3.873808772950932*^9, 
   3.873808779659857*^9}, {3.873808884290216*^9, 3.873808884599793*^9}, {
   3.8738089163721933`*^9, 3.873808916456562*^9}, {3.8738091746792917`*^9, 
   3.8738092359470253`*^9}, 3.8738093101586533`*^9, {3.8750060130070457`*^9, 
   3.8750060334657173`*^9}, {3.875006076442424*^9, 3.8750060826679163`*^9}, {
   3.875006336139847*^9, 3.875006497504402*^9}, 3.8750066750749407`*^9, {
   3.8752397658627243`*^9, 3.875239771778448*^9}, {3.875239859347747*^9, 
   3.8752398597646513`*^9}, {3.875239909974429*^9, 3.8752399330604687`*^9}, 
   3.8768181363627787`*^9, {3.878266239269499*^9, 3.878266273794991*^9}, {
   3.878266308778912*^9, 3.8782663368224583`*^9}, {3.878266540298009*^9, 
   3.878266675596177*^9}, {3.878267103080472*^9, 3.878267205409918*^9}, {
   3.878267249045485*^9, 3.878267249269669*^9}, {3.8782673372197247`*^9, 
   3.878267386601843*^9}, {3.878267464217449*^9, 3.878267483556486*^9}, {
   3.8782676011238003`*^9, 3.878267605594541*^9}, 3.878267770677187*^9, {
   3.8782678821558*^9, 3.87826792733867*^9}, {3.8782680126143217`*^9, 
   3.878268098213587*^9}, {3.878268331407749*^9, 3.878268382362084*^9}, {
   3.878268451023222*^9, 3.8782684517870693`*^9}, {3.87826855271954*^9, 
   3.878268563272753*^9}, {3.8782685945099792`*^9, 3.878268598191057*^9}, {
   3.878268643441039*^9, 3.878268656941559*^9}, {3.878268709422538*^9, 
   3.878268836078299*^9}, {3.878268899897159*^9, 3.878268923417693*^9}, {
   3.878285793152595*^9, 3.878285793661284*^9}, {3.878293650481924*^9, 
   3.878293663840891*^9}, {3.878626891888763*^9, 3.878627066296997*^9}, {
   3.878627133602454*^9, 3.878627300632635*^9}, {3.878627407260272*^9, 
   3.878627473256608*^9}, 3.8786299969419394`*^9, {3.878634157251501*^9, 
   3.87863419347583*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"adaaab1c-7079-4802-8a37-6dc988bf8d3e"],

Cell[CellGroupData[{

Cell["Spin orbitals", "Title",
 CellChangeTimes->{{3.878627342593546*^9, 
  3.878627346857836*^9}},ExpressionUUID->"7ccda15b-a6e4-49ba-a300-\
dd4e56d9a3a3"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spinorbG0T0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "TDA_", ",", "TDAT_", ",", "\[Eta]_", ",", 
     "verbose_", ",", "lin_", ",", "s_", ",", "options_", ",", 
     "regularizerorbital_", ",", "regularizerselfenergy_"}], "]"}], ":=", 
   "\n", "\n", "  ", 
   RowBox[{"Module", "[", "\n", "    ", 
    RowBox[{
     RowBox[{"{", "\n", "      ", 
      RowBox[{
      "nOO", ",", "nVV", ",", "ispin", ",", "linearppquantities", ",", 
       "\[CapitalOmega]1", ",", "X1", ",", "Y1", ",", "\[CapitalOmega]2", ",",
        "X2", ",", "Y2", ",", "ppquantities", ",", "\[Rho]1", ",", "\[Rho]2", 
       ",", "\n", "      ", "SelfEnergyquantities", ",", "\[CapitalSigma]c", 
       ",", "\[CapitalSigma]x", ",", "Z", ",", "soeG0T0", ",", "EcppRPA", ",",
        "outputs", ",", "\n", "      ", "EcppRPAsinglet", ",", 
       "EcppRPAtriplet", ",", "Im\[CapitalSigma]c\[Omega]", ",", 
       "Im\[CapitalSigma]c", ",", "\[CapitalSigma]c\[Omega]", ",", 
       "soeG0T0lin", ",", "IP", ",", "TabG0T0", ",", "EcGM", ",", "nBas2", 
       ",", "nO2", ",", "nV2", ",", "\n", "      ", "so\[Epsilon]", ",", 
       "soERI", ",", "soeRenorm", ",", "d\[CapitalSigma]cd\[Omega]"}], "\n", 
      "    ", "}"}], ",", "\n", "    ", "\n", "    ", 
     RowBox[{"(*", 
      RowBox[{"Define", " ", "the", " ", "spaces"}], "*)"}], "\n", "    ", 
     RowBox[{
      RowBox[{"nBas2", "=", 
       RowBox[{"2", "nBas"}]}], ";", "\n", "    ", 
      RowBox[{"nO2", "=", 
       RowBox[{"2", "nO"}]}], ";", "\n", "    ", 
      RowBox[{"nV2", "=", 
       RowBox[{"2", "nV"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Spatial", " ", "to", " ", "spin", " ", "orbitals"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{
       "path", "<>", "\"\</src/utils/spatial_to_spin_MO_energy.nb\>\""}], 
       "]"}], ";", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/utils/spatial_to_spin_ERI.nb\>\""}], 
       "]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"so\[Epsilon]", "=", 
       RowBox[{"SpatialToSpinMOEnergy", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]"}], "]"}]}], 
      ";", "\n", "    ", 
      RowBox[{"soERI", "=", 
       RowBox[{"SpatialToSpinERI", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "ERI"}], "]"}]}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"nOO", "=", 
       RowBox[{"nO2", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nO2", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", "    ", 
      RowBox[{"nVV", "=", 
       RowBox[{"nV2", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nV2", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"soeG0T0", "=", "so\[Epsilon]"}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"spin", " ", "orbital", " ", "basis"}], "*)"}], "\n", "    ", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/LR/linear_response_pp.nb\>\""}], "]"}],
       ";", "\n", "    ", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas2", ",", "nO2", ",", "nV2", ",", "nOO", ",", "nVV", ",", "soERI",
          ",", "so\[Epsilon]", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", 
      "\n", "    ", 
      RowBox[{"\[CapitalOmega]1", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]1\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X1", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y1", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[CapitalOmega]2", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]2\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X2", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X2\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y2", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y2\>\"", "]"}]}], ";", "\n", 
      "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/GT/excitation_density.nb\>\""}], "]"}],
       ";", "\n", "    ", 
      RowBox[{"ppquantities", "=", 
       RowBox[{"ppsIntegral", "[", 
        RowBox[{
        "nBas2", ",", "nO2", ",", "nV2", ",", "soERI", ",", "X1", ",", "Y1", 
         ",", "X2", ",", "Y2", ",", "nOO", ",", "nVV", ",", "ispin"}], 
        "]"}]}], ";", "\n", "    ", 
      RowBox[{"\[Rho]1", "=", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[Rho]2", "=", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]2\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", "     ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", "    ", "\n", "    ", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"so\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"cd", "=", "1"}], "nVV"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]1", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", "    ",
       "\n", "    ", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"soeRenorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOO"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]2", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", "    ",
       "\n", "    ", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"Re", "[", "soeRenorm", "]"}]}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Self", " ", "energy"}], " ", "*)"}], "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"cd", "=", "1"}], "nVV"], 
           RowBox[{
            FractionBox[
             SuperscriptBox[
              RowBox[{"\[Rho]1", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}], 
              "2"], 
             RowBox[{"\[Omega]", "+", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";", "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOO"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]2", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{"\[Omega]", "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", "    ",
       "\n", "    ", "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], "*)"}], "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"cd", "=", "1"}], "nVV"], 
           RowBox[{
            FractionBox[
             RowBox[{"-", 
              SuperscriptBox[
               RowBox[{"\[Rho]1", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"]}], 
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"\[Omega]", "+", 
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "\[CapitalOmega]1", "\[LeftDoubleBracket]", "cd", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOO"], 
            RowBox[{
             FractionBox[
              RowBox[{"-", 
               SuperscriptBox[
                RowBox[{"\[Rho]2", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "kl"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{"\[Omega]", "+", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", "    ",
       "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "d\[CapitalSigma]cd\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"Z", " ", "=", " ", 
       FractionBox["1", 
        RowBox[{"1", "-", "d\[CapitalSigma]cd\[Omega]"}]]}], ";", "\n", 
      "    ", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      "    ", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"soeG0T0lin", " ", "=", " ", 
       RowBox[{"so\[Epsilon]", " ", "+", " ", 
        RowBox[{"Z", "*", "\[CapitalSigma]c"}]}]}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "    ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{"soeG0T0", " ", "=", " ", "soeG0T0lin"}]}], ",", "\n", 
        "      ", "\n", "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{"soeG0T0", "=", 
          RowBox[{"\[Omega]", "/.", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"FindRoot", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Omega]", ",", 
                 RowBox[{
                 "soeG0T0lin", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";"}]}], "\n", 
       "      ", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"eG0T0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"NSolve", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]HF", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", "\[Omega]"}], "]"}]}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}], "*)"}], 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{
           RowBox[{"eG0T0", "*", "HaToeV"}], "//", "MatrixForm"}], "]"}], 
         ";"}], "*)"}], "\n", "    ", "]"}], ";", "\n", "    ", "\n", "    ", 
      
      RowBox[{"(*", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], "*)"}], "\n", 
      "    ", 
      RowBox[{"IP", " ", "=", " ", 
       RowBox[{
        RowBox[{"Max", "[", 
         RowBox[{"Select", "[", 
          RowBox[{"soeG0T0", ",", 
           RowBox[{
            RowBox[{"#", "<", "0"}], " ", "&"}]}], "]"}], "]"}], "*", 
        "HaToeV"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"pp", "-", 
        RowBox[{"RPA", " ", "correlation", " ", "energy"}]}], "*)"}], "\n", 
      "   ", "\n", "    ", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas2", ",", "nO2", ",", "nV2", ",", "nOO", ",", "nVV", ",", "soERI",
          ",", "soeG0T0", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"EcppRPA", "=", 
       RowBox[{"linearppquantities", "[", "\"\<EcppRPA\>\"", "]"}]}], ";", 
      "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Print", " ", "outputs"}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GT/print_G0T0.nb\>\""}], "]"}], ";",
          "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0T0 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"TabG0T0", " ", "=", " ", 
          RowBox[{"PrintG0T0", "[", 
           RowBox[{
           "nO2", ",", "so\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",",
             "soeG0T0", ",", "ENuc", ",", "ERHF", ",", "EcppRPA", ",", "0", 
            ",", "EcGM"}], "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabG0T0", "]"}], ";"}]}], "\n", "    ", "]"}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{"outputs", "=", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<EcppRPA\>\"", "\[Rule]", "EcppRPA"}], ",", 
         RowBox[{"\"\<eG0T0\>\"", "\[Rule]", "soeG0T0"}], ",", 
         RowBox[{"\"\<Z\>\"", "\[Rule]", "Z"}], ",", 
         RowBox[{"\"\<\[CapitalSigma]c\>\"", "\[Rule]", "\[CapitalSigma]c"}], 
         ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}]}], "]"}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"Return", "[", "outputs", "]"}], ";"}]}], "\n", "    ", "\n", 
    "  ", "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.878633564637542*^9, 3.878633724427492*^9}, {
  3.878633778296496*^9, 3.878634082964719*^9}, {3.87863411992791*^9, 
  3.878634137441908*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"11c42107-63a2-4ab1-85dc-7c31f0cf0e94"]
}, Closed]],

Cell[CellGroupData[{

Cell["Spatial orbitals", "Title",
 CellChangeTimes->{{3.878627352070225*^9, 
  3.878627355655319*^9}},ExpressionUUID->"7d39b1bc-c867-45ed-8a00-\
c6d3229ae58f"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spatialorbG0T0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "TDA_", ",", "TDAT_", ",", "\[Eta]_", ",", 
     "verbose_", ",", "lin_", ",", "s_", ",", "options_", ",", 
     "regularizerorbital_", ",", "regularizerselfenergy_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\n", "\n", "    ", 
    RowBox[{
     RowBox[{"{", "\n", "      ", 
      RowBox[{
      "nOOs", ",", "nVVs", ",", "nOOt", ",", "nVVt", ",", "ispin", ",", 
       "linearppquantities", ",", "\[CapitalOmega]1s", ",", "X1s", ",", "Y1s",
        ",", "\[CapitalOmega]2s", ",", "X2s", ",", "Y2s", ",", "ppquantities",
        ",", "\[Rho]1s", ",", "\[Rho]2s", ",", "\n", "      ", 
       "SelfEnergyquantities", ",", "\[CapitalSigma]c", ",", 
       "\[CapitalSigma]x", ",", "\[CapitalOmega]1t", ",", "X1t", ",", "Y1t", 
       ",", "\[CapitalOmega]2t", ",", "X2t", ",", "Y2t", ",", "\[Rho]1t", ",",
        "\[Rho]2t", ",", "Z", ",", "eG0T0", ",", "EcppRPA", ",", "outputs", 
       ",", "\n", "      ", "EcppRPAsinglet", ",", "EcppRPAtriplet", ",", 
       "Im\[CapitalSigma]c\[Omega]", ",", "Im\[CapitalSigma]c", ",", 
       "\[CapitalSigma]c\[Omega]", ",", "eG0T0lin", ",", "IP", ",", "TabG0T0",
        ",", "EcGM", ",", "TabLR", ",", "time", ",", "\n", "      ", 
       "regularizermethod", ",", "BSE", ",", "dBSE", ",", "dTDA", ",", 
       "singlet", ",", "triplet", ",", "eRenorm", ",", 
       "d\[CapitalSigma]cd\[Omega]", ",", "EcBSE"}], "\n", "    ", "}"}], ",",
      "\n", "\n", "    ", 
     RowBox[{
      RowBox[{"nOOs", "=", 
       RowBox[{"nO", "*", "nO"}]}], ";", " ", "\n", "    ", 
      RowBox[{"nVVs", "=", 
       RowBox[{"nV", "*", "nV"}]}], ";", " ", "\n", "\n", "    ", 
      RowBox[{"nOOt", "=", 
       RowBox[{"nO", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nO", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", "    ", 
      
      RowBox[{"nVVt", "=", 
       RowBox[{"nV", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nV", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"eG0T0", "=", "\[Epsilon]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", " ", "options", " ", "*)"}], "\n", "    ", 
      RowBox[{"BSE", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<BSE\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"dBSE", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<dBSE\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"dTDA", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<dTDA\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"singlet", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<singlet\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", 
      RowBox[{"triplet", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<triplet\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "    ", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"(*", 
       RowBox[{"block", " ", "\[Alpha]\[Beta]"}], "*)"}], "\n", "    ", 
      RowBox[{"ispin", "=", "3"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/LR/linear_response_pp.nb\>\""}], "]"}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{
        "\"\<ppRPA calculation for \[Alpha]\[Beta] block...\>\"", ",", "Bold",
          ",", "Red"}], "]"}], "]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearppquantities"}], "}"}], " ", "=", " ", 
       RowBox[{"Timing", "[", 
        RowBox[{"linearpp", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "nOOs", ",", "nVVs", ",", "ERI", 
          ",", "\[Epsilon]", ",", "ispin", ",", "TDAT"}], "]"}], "]"}]}], ";",
       "\n", "    ", "\n", "    ", 
      RowBox[{"\[CapitalOmega]1s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]1\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X1s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y1s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[CapitalOmega]2s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]2\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X2s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X2\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y2s", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y2\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"\"\<CPU time = \>\"", ",", "time"}], "]"}], ";", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Done !\>\"", ",", "Bold", ",", "Red"}], "]"}], "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/LR/print_excitation.nb\>\""}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<pp-RPA outputs:\>\"", ",", "Bold", ",", "Red"}], 
           "]"}], "]"}], ";", "\n", "      ", 
         RowBox[{"TabLR", "=", 
          RowBox[{"PrintExcitation", "[", 
           RowBox[{
           "\"\<pp-RPA (N+2)\>\"", ",", "ispin", ",", "\[CapitalOmega]1s"}], 
           "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabLR", "]"}], ";", "\n", "      ", "\n", 
         "      ", 
         RowBox[{"TabLR", "=", 
          RowBox[{"PrintExcitation", "[", 
           RowBox[{
           "\"\<pp-RPA (N-2)\>\"", ",", "ispin", ",", "\[CapitalOmega]2s"}], 
           "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabLR", "]"}], ";"}]}], "\n", "    ", "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/GT/excitation_density.nb\>\""}], "]"}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{
        "\"\<Computation of screened integrals...\>\"", ",", "Bold", ",", 
         "Red"}], "]"}], "]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "ppquantities"}], "}"}], " ", "=", " ", 
       RowBox[{"Timing", "[", 
        RowBox[{"ppsIntegral", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "ERI", ",", "X1s", ",", "Y1s", 
          ",", "X2s", ",", "Y2s", ",", "nOOs", ",", "nVVs", ",", "ispin"}], 
         "]"}], "]"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"\[Rho]1s", " ", "=", " ", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[Rho]2s", " ", "=", " ", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]2\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"\"\<CPU time = \>\"", ",", "time"}], "]"}], ";", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Done !\>\"", ",", "Bold", ",", "Red"}], "]"}], "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", "    ", "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"cd", "=", "1"}], "nVVs"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"eRenorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOs"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"Re", "[", "eRenorm", "]"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Self", " ", "energy"}], " ", "*)"}], "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"cd", "=", "1"}], "nVVs"], 
             RowBox[{
              FractionBox[
               SuperscriptBox[
                RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "i", ",", "cd"}], 
                 "\[RightDoubleBracket]"}], "2"], 
               RowBox[{"\[Omega]", "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
              RowBox[{"regularizerselfenergy", "[", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
           RowBox[{"{", 
            RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}], "*)"}], "\n",
       "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"cd", "=", "1"}], "nVVs"], 
           FractionBox[
            RowBox[{
             SuperscriptBox[
              RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}], 
              "2"], "*", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}]}], ")"}]}], 
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
             SuperscriptBox["\[Eta]", "2"]}]]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
         RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{"nO", "+", "1"}]}], "nBas"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"kl", "=", "1"}], "nOOs"], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "a", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"\[Omega]", "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOs"], 
            FractionBox[
             RowBox[{
              SuperscriptBox[
               RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], "*", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                 "\[RightDoubleBracket]"}]}], ")"}]}], 
             RowBox[{
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
              SuperscriptBox["\[Eta]", "2"]}]]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], "*)"}], "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"cd", "=", "1"}], "nVVs"], 
             RowBox[{
              FractionBox[
               RowBox[{"-", 
                SuperscriptBox[
                 RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "i", ",", "cd"}], 
                  "\[RightDoubleBracket]"}], "2"]}], 
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{"\[Omega]", "+", 
                  RowBox[{
                  "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
              RowBox[{"regularizerselfenergy", "[", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
           RowBox[{"{", 
            RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}], "*)"}], "\n",
       "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"cd", "=", "1"}], "nVVs"], 
           RowBox[{
            RowBox[{"-", 
             SuperscriptBox[
              RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}], 
              "2"]}], "*", 
            SuperscriptBox[
             RowBox[{"(", 
              FractionBox[
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]], ")"}], "2"]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOs"], 
            RowBox[{
             RowBox[{"-", 
              SuperscriptBox[
               RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"]}], "*", 
             SuperscriptBox[
              RowBox[{"(", 
               FractionBox[
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], 
                RowBox[{
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                 SuperscriptBox["\[Eta]", "2"]}]], ")"}], "2"]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"(*", 
        RowBox[{"Galitskii", "-", 
         RowBox[{"Migdal", " ", "correlation", " ", "energy"}]}], "*)"}], 
       "\n", "    ", 
       RowBox[{
        RowBox[{"EcGM", " ", "=", " ", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"j", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"cd", "=", "1"}], "nVVs"], 
             FractionBox[
              RowBox[{
               SuperscriptBox[
                RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                 RowBox[{"i", ",", "j", ",", "cd"}], 
                 "\[RightDoubleBracket]"}], "2"], "*", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                 "+", 
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], 
                 "-", 
                 RowBox[{
                 "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}]}], ")"}]}], 
              RowBox[{
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                   "+", 
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}],
                   "-", 
                  RowBox[{
                  "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                   "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
               SuperscriptBox["\[Eta]", "2"]}]]}]}]}], " ", "+", 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"b", "=", 
              RowBox[{"nO", "+", "1"}]}], "nBas"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"kl", "=", "1"}], "nOOs"], 
             FractionBox[
              RowBox[{
               RowBox[{"-", 
                SuperscriptBox[
                 RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                  RowBox[{"a", ",", "b", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"]}], "*", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}], 
                 "+", 
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
                 "-", 
                 RowBox[{
                 "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], ")"}]}], 
              RowBox[{
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}],
                   "+", 
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                   "-", 
                  RowBox[{
                  "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                   "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
               SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}]}], ";"}], "*)"}], 
      "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"\[Alpha]\[Alpha]", " ", "block"}], "*)"}], "\n", "    ", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{
        "\"\<ppRPA calculation for \[Alpha]\[Alpha] block...\>\"", ",", 
         "Bold", ",", "Red"}], "]"}], "]"}], ";", "\n", "    ", "\n", "    ", 
      
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearppquantities"}], "}"}], " ", "=", " ", 
       RowBox[{"Timing", "[", 
        RowBox[{"linearpp", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "nOOt", ",", "nVVt", ",", "ERI", 
          ",", "\[Epsilon]", ",", "ispin", ",", "TDAT"}], "]"}], "]"}]}], ";",
       "\n", "    ", "\n", "    ", 
      RowBox[{"\[CapitalOmega]1t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]1\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X1t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y1t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[CapitalOmega]2t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<\[CapitalOmega]2\>\"", "]"}]}],
       ";", "\n", "    ", 
      RowBox[{"X2t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<X2\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"Y2t", "=", 
       RowBox[{"linearppquantities", "[", "\"\<Y2\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"\"\<CPU time = \>\"", ",", "time"}], "]"}], ";", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Done !\>\"", ",", "Bold", ",", "Red"}], "]"}], "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/LR/print_excitation.nb\>\""}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<pp-RPA outputs:\>\"", ",", "Bold", ",", "Red"}], 
           "]"}], "]"}], ";", "\n", "      ", 
         RowBox[{"TabLR", "=", 
          RowBox[{"PrintExcitation", "[", 
           RowBox[{
           "\"\<pp-RPA (N+2)\>\"", ",", "ispin", ",", "\[CapitalOmega]1t"}], 
           "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabLR", "]"}], ";", "\n", "      ", "\n", 
         "      ", 
         RowBox[{"TabLR", "=", 
          RowBox[{"PrintExcitation", "[", 
           RowBox[{
           "\"\<pp-RPA (N-2)\>\"", ",", "ispin", ",", "\[CapitalOmega]2t"}], 
           "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabLR", "]"}], ";"}]}], "\n", "    ", "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{
        "\"\<Computation of screened integrals...\>\"", ",", "Bold", ",", 
         "Red"}], "]"}], "]"}], ";", "\n", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "ppquantities"}], "}"}], " ", "=", " ", 
       RowBox[{"Timing", "[", 
        RowBox[{"ppsIntegral", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "ERI", ",", "X1t", ",", "Y1t", 
          ",", "X2t", ",", "Y2t", ",", "nOOt", ",", "nVVt", ",", "ispin"}], 
         "]"}], "]"}]}], ";", "\n", "    ", 
      RowBox[{"\[Rho]1t", "=", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]1\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[Rho]2t", "=", 
       RowBox[{"ppquantities", "[", "\"\<\[Rho]2\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"\"\<CPU time = \>\"", ",", "time"}], "]"}], ";", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Done !\>\"", ",", "Bold", ",", "Red"}], "]"}], "]"}], 
      ";", "\n", "    ", "\n", "     ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", "    ", "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"cd", "=", "1"}], "nVVt"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"eRenorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOt"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"eRenorm", " ", "=", " ", 
       RowBox[{"Re", "[", "eRenorm", "]"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Self", " ", "energy"}], " ", "*)"}], "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
         RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"i", "=", "1"}], "nO"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"cd", "=", "1"}], "nVVt"], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "i", ",", "cd"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"\[Omega]", "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"cd", "=", "1"}], "nVVt"], 
            FractionBox[
             RowBox[{
              SuperscriptBox[
               RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"], "*", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                 "\[RightDoubleBracket]"}]}], ")"}]}], 
             RowBox[{
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
              SuperscriptBox["\[Eta]", "2"]}]]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
         RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{"nO", "+", "1"}]}], "nBas"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"kl", "=", "1"}], "nOOt"], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "a", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"\[Omega]", "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOt"], 
            FractionBox[
             RowBox[{
              SuperscriptBox[
               RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"], "*", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                 "\[RightDoubleBracket]"}]}], ")"}]}], 
             RowBox[{
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
              SuperscriptBox["\[Eta]", "2"]}]]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], " ", "*)"}], "\n", "    ", 
      
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
         RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"i", "=", "1"}], "nO"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"cd", "=", "1"}], "nVVt"], 
              RowBox[{
               FractionBox[
                RowBox[{"-", 
                 SuperscriptBox[
                  RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                   RowBox[{"p", ",", "i", ",", "cd"}], 
                   "\[RightDoubleBracket]"}], "2"]}], 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{"\[Omega]", "+", 
                   RowBox[{
                   "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"cd", "=", "1"}], "nVVt"], 
            RowBox[{
             RowBox[{"-", 
              SuperscriptBox[
               RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "cd"}], "\[RightDoubleBracket]"}],
                "2"]}], "*", 
             SuperscriptBox[
              RowBox[{"(", 
               FractionBox[
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                  "\[RightDoubleBracket]"}]}], 
                RowBox[{
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                 SuperscriptBox["\[Eta]", "2"]}]], ")"}], "2"]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
         RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{"nO", "+", "1"}]}], "nBas"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"kl", "=", "1"}], "nOOt"], 
              RowBox[{
               FractionBox[
                RowBox[{"-", 
                 SuperscriptBox[
                  RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                   RowBox[{"p", ",", "a", ",", "kl"}], 
                   "\[RightDoubleBracket]"}], "2"]}], 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{"\[Omega]", "+", 
                   RowBox[{
                   "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"kl", "=", "1"}], "nOOt"], 
            RowBox[{
             RowBox[{"-", 
              SuperscriptBox[
               RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "kl"}], "\[RightDoubleBracket]"}],
                "2"]}], "*", 
             SuperscriptBox[
              RowBox[{"(", 
               FractionBox[
                RowBox[{
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], 
                RowBox[{
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                 SuperscriptBox["\[Eta]", "2"]}]], ")"}], "2"]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
         RowBox[{"Re", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
             "d\[CapitalSigma]cd\[Omega]", "\[LeftDoubleBracket]", "p", 
              "\[RightDoubleBracket]"}], "/.", 
             RowBox[{"\[Omega]", "\[Rule]", 
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}], "]"}]}], ";"}], 
       "*)"}], "\n", "    ", "\n", "    ", 
      RowBox[{"Z", " ", "=", " ", 
       FractionBox["1", 
        RowBox[{"1", "-", "d\[CapitalSigma]cd\[Omega]"}]]}], ";", "\n", 
      "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
         RowBox[{"Re", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
             "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
              "\[RightDoubleBracket]"}], "/.", 
             RowBox[{"\[Omega]", "\[Rule]", 
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}], "]"}]}], ";"}], 
       "*)"}], "\n", "    ", 
      RowBox[{"\[CapitalSigma]c", "=", "\[CapitalSigma]c\[Omega]"}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"(*", 
        RowBox[{"Galitskii", "-", 
         RowBox[{"Migdal", " ", "correlation", " ", "energy"}]}], "*)"}], 
       "\n", "    ", 
       RowBox[{
        RowBox[{"EcGM", " ", "=", " ", 
         RowBox[{
          RowBox[{"EcGM", " ", 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"j", "=", "1"}], "nO"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"cd", "=", "1"}], "nVVt"], 
              FractionBox[
               RowBox[{
                SuperscriptBox[
                 RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", "j", ",", "cd"}], 
                  "\[RightDoubleBracket]"}], "2"], "*", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                   "+", 
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}],
                   "-", 
                  RowBox[{
                  "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "e", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "e", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}], " ", "+", 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"b", "=", 
              RowBox[{"nO", "+", "1"}]}], "nBas"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"kl", "=", "1"}], "nOOt"], 
             FractionBox[
              RowBox[{
               RowBox[{"-", 
                SuperscriptBox[
                 RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                  RowBox[{"a", ",", "b", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"]}], "*", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}], 
                 "+", 
                 RowBox[{
                 "e", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
                 "-", 
                 RowBox[{
                 "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                  "\[RightDoubleBracket]"}]}], ")"}]}], 
              RowBox[{
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}],
                   "+", 
                  RowBox[{
                  "e", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                   "-", 
                  RowBox[{
                  "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                   "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
               SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}]}], ";"}], "*)"}], 
      "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Exchange", " ", "part", " ", "of", " ", "the", " ", "self"}],
         "-", "energy"}], "*)"}], "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"\[CapitalSigma]x", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"\[Mu]", "=", "1"}], "nBas"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"\[Nu]", "=", "1"}], "nBas"], 
             RowBox[{
              RowBox[{"C", "\[LeftDoubleBracket]", 
               RowBox[{"\[Mu]", ",", "p"}], "\[RightDoubleBracket]"}], "*", 
              RowBox[{"K", "\[LeftDoubleBracket]", 
               RowBox[{"\[Mu]", ",", "\[Nu]"}], "\[RightDoubleBracket]"}], 
              "*", 
              RowBox[{"C", "\[LeftDoubleBracket]", 
               RowBox[{"\[Nu]", ",", "p"}], "\[RightDoubleBracket]"}]}]}]}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}], "*)"}], "\n",
       "    ", 
      RowBox[{"(*", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{
        "\"\<Computation of quasiparticles energies...\>\"", ",", "Bold", ",",
          "Red"}], "]"}], "]"}], ";", "\n", "    ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "eG0T0lin"}], "}"}], " ", "=", " ", 
       RowBox[{"Timing", "[", 
        RowBox[{"\[Epsilon]", " ", "+", " ", 
         RowBox[{"Z", "*", 
          RowBox[{"(", " ", 
           RowBox[{"(*", 
            RowBox[{"\[CapitalSigma]x", " ", "+"}], "*)"}], " ", 
           "\[CapitalSigma]c", " ", 
           RowBox[{"(*", 
            RowBox[{"-", " ", "Vxc"}], "*)"}], ")"}]}]}], "]"}]}], ";", "\n", 
      "    ", "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "    ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{"eG0T0", " ", "=", " ", "eG0T0lin"}]}], ",", "\n", "      ", 
        "\n", "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"time", ",", "eG0T0"}], "}"}], " ", "=", " ", 
          RowBox[{"Timing", "[", 
           RowBox[{"\[Omega]", "/.", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"FindRoot", "[", 
               RowBox[{
                RowBox[{"\[Omega]", "\[Equal]", 
                 RowBox[{
                  RowBox[{
                  "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                   "\[RightDoubleBracket]"}], 
                  RowBox[{"(*", 
                   RowBox[{"+", 
                    RowBox[{
                    "\[CapitalSigma]x", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}]}], "*)"}], "+", 
                  RowBox[{
                  "\[CapitalSigma]c", "\[LeftDoubleBracket]", "p", 
                   "\[RightDoubleBracket]"}]}]}], 
                RowBox[{"(*", 
                 RowBox[{"-", 
                  RowBox[{
                  "Vxc", "\[LeftDoubleBracket]", "p", 
                   "\[RightDoubleBracket]"}]}], "*)"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Omega]", ",", 
                  RowBox[{
                  "eG0T0lin", "\[LeftDoubleBracket]", "p", 
                   "\[RightDoubleBracket]"}]}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], "]"}]}], ";"}]}],
        "\n", "      ", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"eG0T0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"NSolve", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]HF", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", "\[Omega]"}], "]"}]}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}], "*)"}], 
       "\n", "    ", "]"}], ";", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{
          RowBox[{"eG0T0", "*", "HaToeV"}], "//", "MatrixForm"}], "]"}], 
        ";"}], "*)"}], "\n", "    ", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"\"\<CPU time = \>\"", ",", "time"}], "]"}], ";", "\n", "    ", 
      RowBox[{"PrintTemporary", "[", 
       RowBox[{"Style", "[", 
        RowBox[{"\"\<Done !\>\"", ",", "Bold", ",", "Red"}], "]"}], "]"}], 
      ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], "*)"}], "\n", 
      "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"IP", " ", "=", " ", 
         RowBox[{
          RowBox[{"Max", "[", 
           RowBox[{"Select", "[", 
            RowBox[{"eG0T0", ",", 
             RowBox[{
              RowBox[{"#", "<", "0"}], " ", "&"}]}], "]"}], "]"}], "*", 
          "HaToeV"}]}], ";"}], "*)"}], "\n", "    ", 
      RowBox[{"IP", " ", "=", " ", 
       RowBox[{
        RowBox[{
        "eG0T0", "\[LeftDoubleBracket]", "nO", "\[RightDoubleBracket]"}], "*",
         "HaToeV"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"pp", "-", 
        RowBox[{"RPA", " ", "correlation", " ", "energy"}]}], "*)"}], "\n", 
      "    ", 
      RowBox[{"ispin", "=", "3"}], ";", "\n", "    ", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas", ",", "nO", ",", "nV", ",", "nOOs", ",", "nVVs", ",", "ERI", 
         ",", "eG0T0", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"EcppRPAsinglet", "=", 
       RowBox[{"linearppquantities", "[", "\"\<EcppRPA\>\"", "]"}]}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", "    ", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas", ",", "nO", ",", "nV", ",", "nOOt", ",", "nVVt", ",", "ERI", 
         ",", "eG0T0", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"EcppRPAtriplet", "=", 
       RowBox[{"linearppquantities", "[", "\"\<EcppRPA\>\"", "]"}]}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"EcppRPAsinglet", "=", 
       RowBox[{"EcppRPAsinglet", "-", "EcppRPAtriplet"}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"EcppRPAtriplet", "=", 
       RowBox[{"3", "EcppRPAtriplet"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"EcppRPA", "=", 
       RowBox[{"EcppRPAsinglet", "+", "EcppRPAtriplet"}]}], ";", "\n", "    ",
       "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Print", " ", "outputs"}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GT/print_G0T0.nb\>\""}], "]"}], ";",
          "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0T0 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"TabG0T0", " ", "=", " ", 
          RowBox[{"PrintG0T0", "[", 
           RowBox[{
           "nO", ",", "\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",", 
            "eG0T0", ",", "ENuc", ",", "ERHF", ",", "EcppRPAsinglet", ",", 
            "EcppRPAtriplet", ",", "EcGM"}], "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabG0T0", "]"}], ";"}]}], "\n", "    ", "]"}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"BSE", " ", "calculation"}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"BSE", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<BSE calculation...\>\"", ",", "Bold", ",", "Orange"}],
            "]"}], "]"}], ";", "\n", "      ", 
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GT/BSEGT.nb\>\""}], "]"}], ";", 
         "\n", "      ", "\n", "      ", 
         RowBox[{"EcBSE", " ", "=", " ", 
          RowBox[{"BSEGT", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "nOOs", ",", "nVVs", ",", 
            "nOOt", ",", "nVVt", ",", "\[Rho]1s", ",", "\[Rho]2s", ",", 
            "\[Rho]1t", ",", "\[Rho]2t", ",", "\[Epsilon]", ",", "eG0T0", ",",
             "ERI", ",", "TDA", ",", "TDAT", ",", "dBSE", ",", "dTDA", ",", 
            "\n", "                    ", "singlet", ",", "triplet", ",", 
            "\[Eta]", ",", "verbose"}], "]"}]}], ";"}]}], "\n", "    ", "]"}],
       ";", "\n", "\n", "    ", 
      RowBox[{"outputs", "=", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<EcppRPA\>\"", "\[Rule]", "EcppRPA"}], ",", 
         RowBox[{"\"\<eG0T0\>\"", "\[Rule]", "eG0T0"}], ",", 
         RowBox[{"\"\<Z\>\"", "\[Rule]", "Z"}], ",", 
         RowBox[{"\"\<\[CapitalSigma]c\>\"", "\[Rule]", "\[CapitalSigma]c"}], 
         ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}], ",", 
         RowBox[{"\"\<EcBSE\>\"", "\[Rule]", "EcBSE"}]}], "]"}]}], ";", "\n", 
      "\n", "    ", 
      RowBox[{"Return", "[", "outputs", "]"}], ";"}]}], "\n", "  ", "\n", 
    "  ", "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.878627361761776*^9, 3.8786273726453342`*^9}, {
   3.878627460057164*^9, 3.878627593725552*^9}, {3.878627661430765*^9, 
   3.878627714542638*^9}, {3.878627875138721*^9, 3.87862789207148*^9}, {
   3.878627926578248*^9, 3.878627982072123*^9}, {3.8786280150745173`*^9, 
   3.878628552873952*^9}, {3.8786285935569687`*^9, 3.878628609703952*^9}, {
   3.878628722257894*^9, 3.878628862612475*^9}, {3.878628914577643*^9, 
   3.878629039319316*^9}, {3.878629078360742*^9, 3.8786291788526783`*^9}, {
   3.878629217311159*^9, 3.878629238427525*^9}, {3.878629351136519*^9, 
   3.878629379783499*^9}, {3.8786299489295273`*^9, 3.878629953638995*^9}, {
   3.878630087339946*^9, 3.878630132783189*^9}, {3.878630238907566*^9, 
   3.8786302699874563`*^9}, 3.878630467638715*^9, {3.878630600128529*^9, 
   3.8786306070972233`*^9}, {3.878630681155209*^9, 3.878630834633732*^9}, {
   3.8786312559108047`*^9, 3.8786312722003593`*^9}, {3.878631378154868*^9, 
   3.878631423533228*^9}, 3.878631543036509*^9, {3.87863160572958*^9, 
   3.878631759245985*^9}, {3.878631805630966*^9, 3.878631849869425*^9}, {
   3.8786319514773607`*^9, 3.8786320067840767`*^9}, {3.878633349622013*^9, 
   3.878633396874226*^9}, {3.881901575002796*^9, 3.8819016929139853`*^9}, {
   3.881901765890308*^9, 3.881901835348358*^9}, {3.8819026585692587`*^9, 
   3.881902914334936*^9}, 3.881902993267418*^9},
 CellLabel->"In[3]:=",ExpressionUUID->"38efb114-3ae4-42f1-a48b-6be38bcff0c2"]
}, Closed]]
},
WindowSize->{1416, 679},
WindowMargins->{{Automatic, 11}, {Automatic, 43}},
Magnification:>1.25 Inherited,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (June 19, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"793c55e8-7871-41c1-96e6-25a79a1c7aa5"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 21693, 361, 1217, "Code",ExpressionUUID->"adaaab1c-7079-4802-8a37-6dc988bf8d3e"],
Cell[CellGroupData[{
Cell[22276, 385, 156, 3, 123, "Title",ExpressionUUID->"7ccda15b-a6e4-49ba-a300-dd4e56d9a3a3"],
Cell[22435, 390, 22721, 533, 2879, "Code",ExpressionUUID->"11c42107-63a2-4ab1-85dc-7c31f0cf0e94"]
}, Closed]],
Cell[CellGroupData[{
Cell[45193, 928, 159, 3, 89, "Title",ExpressionUUID->"7d39b1bc-c867-45ed-8a00-c6d3229ae58f"],
Cell[45355, 933, 67847, 1585, 5974, "Code",ExpressionUUID->"38efb114-3ae4-42f1-a48b-6be38bcff0c2"]
}, Closed]]
}
]
*)

