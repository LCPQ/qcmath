(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     56775,       1240]
NotebookOptionsPosition[     55829,       1214]
NotebookOutlinePosition[     56254,       1231]
CellTagsIndexPosition[     56211,       1228]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["qsGT", "Title",
 CellChangeTimes->{{3.898647012592301*^9, 
  3.898647015531867*^9}},ExpressionUUID->"f989f59e-4a40-4b13-b87b-\
bee6ba3f3de0"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"qsGT", "[", 
    RowBox[{
    "Nelc_", ",", "nBas_", ",", "nO_", ",", "nV_", ",", "ENuc_", ",", "ERHF_",
      ",", "\[Epsilon]_", ",", "ERI_", ",", "S_", ",", "T_", ",", "V_", ",", 
     "U_", ",", "X_", ",", "C_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\n", 
    RowBox[{
     RowBox[{"{", "outputsqsGT", "}"}], ",", "\n", "\n", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"options", "[", "\"\<spinorbital\>\"", "]"}], "==", "True"}],
         ",", "\n", "\n", "  ", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Spin orbital implementation of qsGW not available!\>\"", "]"}],
          ";", "\n", "\t", "\n", "  ", 
         RowBox[{"outputsqsGT", "=", 
          RowBox[{"spinOrbQsGT", "[", 
           RowBox[{
           "Nelc", ",", "nBas", ",", "nO", ",", "nV", ",", "ENuc", ",", 
            "ERHF", ",", "\[Epsilon]", ",", "ERI", ",", "S", ",", "T", ",", 
            "V", ",", "U", ",", "X", ",", "C", ",", "options", ",", 
            "verbose"}], "]"}]}], ";"}], "\n", "\t", "\n", "  ", ",", 
        RowBox[{"(*", 
         RowBox[{"else", " ", "go", " ", "to", " ", "spatial"}], " ", "*)"}], 
        "\[IndentingNewLine]", "\n", "  ", 
        RowBox[{
         RowBox[{"outputsqsGT", "=", 
          RowBox[{"spatialQsGT", "[", 
           RowBox[{
           "Nelc", ",", "nBas", ",", "nO", ",", "nV", ",", "ENuc", ",", 
            "ERHF", ",", "\[Epsilon]", ",", "ERI", ",", "S", ",", "T", ",", 
            "V", ",", "U", ",", "X", ",", "C", ",", "options", ",", 
            "verbose"}], "]"}]}], ";"}]}], "\n", "  \t", "\n", "]"}], ";", 
      "\n", "\n", 
      RowBox[{"Return", "[", "outputsqsGT", "]"}], ";"}]}], "\n", "\n", 
    "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.898647029244483*^9, 3.8986471162300653`*^9}, {
   3.898647150404929*^9, 3.898647239928032*^9}, 3.89864742702396*^9, 
   3.898647902749136*^9},
 CellLabel->"In[1]:=",ExpressionUUID->"fe89e349-cd95-4e7a-896c-34a7cdbf6edb"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spin orbitals", "Title",
 CellChangeTimes->{{3.8986478299861298`*^9, 
  3.8986478327634993`*^9}},ExpressionUUID->"fbee2e4f-cfe4-4130-b014-\
86f702c106aa"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spinOrbQsGT", "[", 
    RowBox[{
    "Nelc_", ",", "nBas_", ",", "nO_", ",", "nV_", ",", "ENuc_", ",", "ERHF_",
      ",", "\[Epsilon]_", ",", "ERI_", ",", "S_", ",", "T_", ",", "V_", ",", 
     "U_", ",", "X_", ",", "C_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\n", "\n", 
     RowBox[{
      RowBox[{"Return", "[", 
       RowBox[{"Print", "[", 
        RowBox[{"Style", "[", 
         RowBox[{
         "\"\<spinorbital implementation not available!!!\>\"", ",", "Bold", 
          ",", "Red"}], "]"}], "]"}], "]"}], ";"}]}], "\n", "\n", "]"}]}], 
  ";"}]], "Code",
 CellChangeTimes->{{3.898647842740624*^9, 3.898647886640204*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"98df1992-addd-4dd1-aba4-2b19b4f68520"]
}, Closed]],

Cell[CellGroupData[{

Cell["Spatial orbitals", "Title",
 CellChangeTimes->{{3.898647823377125*^9, 
  3.8986478271638603`*^9}},ExpressionUUID->"3c304a8a-200b-466d-8c7c-\
8d29120f259d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spatialQsGT", "[", 
    RowBox[{
    "Nelc_", ",", "nBas_", ",", "nO_", ",", "nV_", ",", "ENuc_", ",", "ERHF_",
      ",", "\[Epsilon]_", ",", "ERI_", ",", "S_", ",", "T_", ",", "V_", ",", 
     "U_", ",", "X_", ",", "C_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\n", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "qsGTquantities", ",", "nOOs", ",", "nVVs", ",", "nOOt", ",", "nVVt", 
       ",", "conv", ",", "thresh", ",", "nSCF", ",", "maxSCF", ",", "ispin", 
       ",", "linearppquantities", ",", "eHF", ",", "\[Epsilon]qsGT", ",", 
       "\n", "\[CapitalOmega]1s", ",", "X1s", ",", "Y1s", ",", 
       "\[CapitalOmega]2s", ",", "X2s", ",", "Y2s", ",", "\[CapitalOmega]1t", 
       ",", "X1t", ",", "Y1t", ",", "\[CapitalOmega]2t", ",", "X2t", ",", 
       "Y2t", ",", "\[CapitalSigma]", ",", "cGT", ",", "FOA", ",", "Hcore", 
       ",", "J", ",", "K", ",", "\n", "Fp", ",", "\[Epsilon]GT", ",", "cpGT", 
       ",", "oldEigenvalues", ",", "Orb", ",", "P", ",", "OAIntegrals", ",", 
       "ERIGT", ",", "UJ", ",", "UK", ",", "EcppRPAab", ",", "EcppRPAaa", ",",
        "\n", "ppquantities", ",", "\[Rho]1s", ",", "\[Rho]2s", ",", 
       "\[Rho]1t", ",", "\[Rho]2t", ",", "qsGET", ",", "qsGEV", ",", "qsGEK", 
       ",", "qsGEJ", ",", "EqsG", ",", "EcGM", ",", "\[Eta]", ",", 
       "qsstaticform", ",", "\n", "DIISEx", ",", "maxDIIS", ",", "nDIIS", ",",
        "TDA", ",", "TDAT", ",", "error", ",", "tmpF", ",", "tmpErrorDIIS", 
       ",", "eDIIS", ",", "FDIIS", ",", "nBasSq", ",", "TabqsGT"}], "}"}], 
     ",", "\n", "\n", 
     RowBox[{"(*", " ", "options", " ", "*)"}], "\n", 
     RowBox[{
      RowBox[{"maxSCF", "=", 
       RowBox[{"options", "[", "\"\<maxSCF_MBPT\>\"", "]"}]}], ";", "\n", 
      RowBox[{"thresh", "=", 
       RowBox[{"options", "[", "\"\<thresh_MBPT\>\"", "]"}]}], ";", "\n", 
      RowBox[{"\[Eta]", "=", 
       RowBox[{"options", "[", "\"\<\[Eta]\>\"", "]"}]}], ";", "\n", 
      RowBox[{"qsstaticform", "=", 
       RowBox[{"options", "[", "\"\<qs_static_form\>\"", "]"}]}], ";", "\n", 
      RowBox[{"DIISEx", "=", 
       RowBox[{"options", "[", "\"\<DIIS\>\"", "]"}]}], ";", "\n", 
      RowBox[{"maxDIIS", "=", 
       RowBox[{"options", "[", "\"\<n_DIIS\>\"", "]"}]}], ";", "\n", 
      "\[IndentingNewLine]", 
      RowBox[{"nDIIS", "=", "0"}], ";", "\n", 
      RowBox[{"TDA", "=", 
       RowBox[{"options", "[", "\"\<TDA\>\"", "]"}]}], ";", "\n", 
      RowBox[{"TDAT", "=", 
       RowBox[{"options", "[", "\"\<TDA_T\>\"", "]"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", "\"\<Tamm-Dancoff approximation activated!\>\"", 
            "]"}]}], "]"}], ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAT", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", "\"\<Tamm-Dancoff approximation for T-matrix!\>\"", 
            "]"}]}], "]"}], ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation activated!\>\"", "]"}]}], "]"}], 
         ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAT", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation for T-matrix!\>\"", "]"}]}], 
          "]"}], ";"}]}], "\n", "]"}], ";", "\n", "\n", 
      RowBox[{"nOOs", "=", 
       RowBox[{"nO", "*", "nO"}]}], ";", "\n", 
      RowBox[{"nVVs", "=", 
       RowBox[{"nV", "*", "nV"}]}], ";", "\n", "\n", 
      RowBox[{"nOOt", "=", 
       RowBox[{"nO", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nO", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", 
      RowBox[{"nVVt", "=", 
       RowBox[{"nV", "*", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"nV", "-", "1"}], ")"}], "/", "2"}]}]}], ";", "\n", "\n", 
      RowBox[{"nBasSq", "=", 
       RowBox[{"nBas", "*", "nBas"}]}], ";", "\n", "\n", 
      RowBox[{"Hcore", " ", "=", " ", 
       RowBox[{"T", " ", "+", " ", "V"}]}], ";", "\n", 
      RowBox[{"OAIntegrals", " ", "=", " ", "U"}], ";", "\n", 
      RowBox[{"UJ", " ", "=", " ", 
       RowBox[{"Flatten", "[", 
        RowBox[{"OAIntegrals", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "3", "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", " ", 
      RowBox[{"UK", " ", "=", " ", 
       RowBox[{"Flatten", "[", 
        RowBox[{"OAIntegrals", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "4", "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}]}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"Orb", "=", 
       RowBox[{
        RowBox[{"Take", "[", 
         RowBox[{
          RowBox[{"C", "\[Transpose]"}], ",", 
          RowBox[{"Nelc", "/", "2"}]}], "]"}], "\[Transpose]"}]}], ";", "\n", 
      
      RowBox[{"P", "=", 
       RowBox[{"2", 
        RowBox[{"Orb", ".", 
         RowBox[{"Orb", "\[Transpose]"}]}]}]}], ";", "\n", 
      RowBox[{"cGT", "=", "C"}], ";", "\n", 
      RowBox[{"ERIGT", "=", "ERI"}], ";", "\n", 
      RowBox[{"\[Epsilon]GT", "=", "\[Epsilon]"}], ";", "\n", 
      RowBox[{"oldEigenvalues", " ", "=", " ", "\[Epsilon]GT"}], ";", "\n", 
      RowBox[{"eHF", "=", "\[Epsilon]"}], ";", "\n", "\n", 
      RowBox[{"(*", "Initialization", "*)"}], "\n", 
      RowBox[{"FDIIS", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "nBasSq"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "maxDIIS"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"eDIIS", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "nBasSq"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "maxDIIS"}], "}"}]}], "]"}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"SCF", " ", "loop"}], "*)"}], "\n", " ", 
      RowBox[{"nSCF", " ", "=", " ", 
       RowBox[{"-", "1"}]}], ";", " ", 
      RowBox[{"conv", "=", "1"}], ";", "\n", "\n", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"conv", " ", ">", " ", "thresh"}], " ", "\[And]", " ", 
         RowBox[{"nSCF", " ", "<", " ", "maxSCF"}]}], ",", " ", 
        RowBox[{
         RowBox[{"nSCF", "++"}], ";", " ", "\n", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", "\[Epsilon]", "]"}], "\[Equal]", "Null"}], 
           ",", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\n", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{"Build", " ", "Coulomb", " ", "matrix"}], "*)"}], "\n", 
         "  ", 
         RowBox[{"J", "=", 
          RowBox[{"UJ", ".", 
           RowBox[{"Flatten", "[", "P", "]"}]}]}], ";", "\n", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{
           "Exchange", " ", "part", " ", "of", " ", "the", " ", "self"}], "-",
            "energy"}], "*)"}], "\n", "  ", 
         RowBox[{"K", "=", 
          RowBox[{"UK", ".", 
           RowBox[{"Flatten", "[", "P", "]"}]}]}], ";", "\n", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{"Two", "-", 
           RowBox[{
           "electrons", " ", "integrals", " ", "in", " ", "MO", " ", 
            "basis"}]}], "*)"}], "\n", "  ", 
         RowBox[{"ERIGT", "=", 
          RowBox[{
           RowBox[{"cGT", "\[Transpose]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"cGT", "\[Transpose]"}], ".", "OAIntegrals", ".", 
              "cGT"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "1", ",", "4", ",", "3"}], "}"}]}], "]"}], 
           ".", "cGT"}]}], ";", "\n", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{"\[Alpha]\[Beta]", " ", "block"}], "*)"}], "\n", "  ", 
         RowBox[{"ispin", "=", "3"}], ";", "\n", "  ", 
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/LR/linear_response_pp.nb\>\""}], 
          "]"}], ";", "\n", "  ", 
         RowBox[{"linearppquantities", "=", 
          RowBox[{"linearpp", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "nOOs", ",", "nVVs", ",", 
            "ERIGT", ",", "\[Epsilon]GT", ",", "ispin", ",", "TDAT"}], 
           "]"}]}], ";", "\n", "  ", 
         RowBox[{"\[CapitalOmega]1s", "=", 
          RowBox[{
          "linearppquantities", "[", "\"\<\[CapitalOmega]1\>\"", "]"}]}], ";",
          "\n", "  ", 
         RowBox[{"X1s", "=", 
          RowBox[{"linearppquantities", "[", "\"\<X1\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"Y1s", "=", 
          RowBox[{"linearppquantities", "[", "\"\<Y1\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"\[CapitalOmega]2s", "=", 
          RowBox[{
          "linearppquantities", "[", "\"\<\[CapitalOmega]2\>\"", "]"}]}], ";",
          "\n", "  ", 
         RowBox[{"X2s", "=", 
          RowBox[{"linearppquantities", "[", "\"\<X2\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"Y2s", "=", 
          RowBox[{"linearppquantities", "[", "\"\<Y2\>\"", "]"}]}], ";", "\n",
          "\n", "  ", 
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GT/excitation_density.nb\>\""}], 
          "]"}], ";", "\n", "  ", 
         RowBox[{"ppquantities", "=", 
          RowBox[{"ppsIntegral", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "ERIGT", ",", "X1s", ",", "Y1s",
             ",", "X2s", ",", "Y2s", ",", "nOOs", ",", "nVVs", ",", "ispin"}],
            "]"}]}], ";", "\n", "  ", 
         RowBox[{"\[Rho]1s", "=", 
          RowBox[{"ppquantities", "[", "\"\<\[Rho]1\>\"", "]"}]}], ";", "\n", 
         "  ", 
         RowBox[{"\[Rho]2s", "=", 
          RowBox[{"ppquantities", "[", "\"\<\[Rho]2\>\"", "]"}]}], ";", "\n", 
         "  ", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"qsstaticform", "==", "\"\<Sym\>\""}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 UnderoverscriptBox["\[Sum]", 
                  RowBox[{"i", "=", "1"}], "nO"], 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"cd", "=", "1"}], "nVVs"], 
                  FractionBox[
                   RowBox[{
                    RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}]}], 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}], "+", 
                RowBox[{
                 UnderoverscriptBox["\[Sum]", 
                  RowBox[{"a", "=", 
                   RowBox[{"nO", "+", "1"}]}], "nBas"], 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"kl", "=", "1"}], "nOOs"], 
                  FractionBox[
                   RowBox[{
                    RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}]}], 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"p", ",", "nBas"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"q", ",", "nBas"}], "}"}]}], "]"}]}], ";"}]}], "\n", 
          "  ", "]"}], ";", "\n", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"qsstaticform", "==", "\"\<SRG\>\""}], ",", "\n", "  ", 
           RowBox[{
            RowBox[{"Print", "[", 
             RowBox[{"Style", "[", 
              RowBox[{
              "\"\<SRG version not implemented yet... Keep going with the \
symmetrized version!\>\"", ",", "Red", ",", "Bold"}], "]"}], "]"}], ";", "\n",
             "    ", 
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 UnderoverscriptBox["\[Sum]", 
                  RowBox[{"i", "=", "1"}], "nO"], 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"cd", "=", "1"}], "nVVs"], 
                  FractionBox[
                   RowBox[{
                    RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}]}], 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}], "+", 
                RowBox[{
                 UnderoverscriptBox["\[Sum]", 
                  RowBox[{"a", "=", 
                   RowBox[{"nO", "+", "1"}]}], "nBas"], 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"kl", "=", "1"}], "nOOs"], 
                  FractionBox[
                   RowBox[{
                    RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}]}], 
                   RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"p", ",", "nBas"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"q", ",", "nBas"}], "}"}]}], "]"}]}], ";"}]}], "\n", 
          "  ", "]"}], ";", "\n", "  ", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{
          "Galitskii", " ", "Migdal", " ", "correlation", " ", "energy"}], 
          "*)"}], "\n", "  ", 
         RowBox[{"EcGM", "=", 
          RowBox[{
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"j", "=", "1"}], "nO"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"cd", "=", "1"}], "nVVs"], 
              FractionBox[
               RowBox[{
                SuperscriptBox[
                 RowBox[{"\[Rho]1s", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", "j", ",", "cd"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "+", 
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]1s", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]]}]}]}], "-", 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"a", "=", 
              RowBox[{"nO", "+", "1"}]}], "nBas"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"b", "=", 
               RowBox[{"nO", "+", "1"}]}], "nBas"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"kl", "=", "1"}], "nOOs"], 
              FractionBox[
               RowBox[{
                SuperscriptBox[
                 RowBox[{"\[Rho]2s", "\[LeftDoubleBracket]", 
                  RowBox[{"a", ",", "b", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                   "\[RightDoubleBracket]"}], "+", 
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "b", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]2s", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}]}], ";", "\n", "\n", 
         "  ", 
         RowBox[{"(*", 
          RowBox[{"\[Alpha]\[Alpha]", " ", "block"}], "*)"}], "\n", "  ", 
         RowBox[{"ispin", "=", "4"}], ";", "\n", "  ", 
         RowBox[{"linearppquantities", "=", 
          RowBox[{"linearpp", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "nOOt", ",", "nVVt", ",", 
            "ERIGT", ",", "\[Epsilon]GT", ",", "ispin", ",", "TDAT"}], 
           "]"}]}], ";", "\n", "  ", 
         RowBox[{"\[CapitalOmega]1t", "=", 
          RowBox[{
          "linearppquantities", "[", "\"\<\[CapitalOmega]1\>\"", "]"}]}], ";",
          "\n", "  ", 
         RowBox[{"X1t", "=", 
          RowBox[{"linearppquantities", "[", "\"\<X1\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"Y1t", "=", 
          RowBox[{"linearppquantities", "[", "\"\<Y1\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"\[CapitalOmega]2t", "=", 
          RowBox[{
          "linearppquantities", "[", "\"\<\[CapitalOmega]2\>\"", "]"}]}], ";",
          "\n", "  ", 
         RowBox[{"X2t", "=", 
          RowBox[{"linearppquantities", "[", "\"\<X2\>\"", "]"}]}], ";", "\n",
          "  ", 
         RowBox[{"Y2t", "=", 
          RowBox[{"linearppquantities", "[", "\"\<Y2\>\"", "]"}]}], ";", "\n",
          "\n", "  ", 
         RowBox[{"ppquantities", "=", 
          RowBox[{"ppsIntegral", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "ERIGT", ",", "X1t", ",", "Y1t",
             ",", "X2t", ",", "Y2t", ",", "nOOt", ",", "nVVt", ",", "ispin"}],
            "]"}]}], ";", "\n", "  ", 
         RowBox[{"\[Rho]1t", "=", 
          RowBox[{"ppquantities", "[", "\"\<\[Rho]1\>\"", "]"}]}], ";", "\n", 
         "  ", 
         RowBox[{"\[Rho]2t", "=", 
          RowBox[{"ppquantities", "[", "\"\<\[Rho]2\>\"", "]"}]}], ";", "\n", 
         "  ", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"qsstaticform", "==", "\"\<Sym\>\""}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"\[CapitalSigma]", "+", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"i", "=", "1"}], "nO"], 
                  RowBox[{
                   UnderoverscriptBox["\[Sum]", 
                    RowBox[{"cd", "=", "1"}], "nVVt"], 
                   FractionBox[
                    RowBox[{
                    RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}]}], 
                    RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}], "+", 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"a", "=", 
                    RowBox[{"nO", "+", "1"}]}], "nBas"], 
                  RowBox[{
                   UnderoverscriptBox["\[Sum]", 
                    RowBox[{"kl", "=", "1"}], "nOOt"], 
                   FractionBox[
                    RowBox[{
                    RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}]}], 
                    RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"p", ",", "nBas"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"q", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
            "    ", 
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"Re", "[", 
              RowBox[{
               FractionBox["1", "2"], 
               RowBox[{"(", 
                RowBox[{"\[CapitalSigma]", "+", 
                 RowBox[{"\[CapitalSigma]", "\[Transpose]"}]}], ")"}]}], 
              "]"}]}], ";"}]}], "\n", "  ", "]"}], ";", "\n", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"qsstaticform", "==", "\"\<SRG\>\""}], ",", "\n", "  ", 
           RowBox[{
            RowBox[{"Print", "[", 
             RowBox[{"Style", "[", 
              RowBox[{
              "\"\<SRG version not implemented yet... Keep going with the \
symmetrized version!\>\"", ",", "Red", ",", "Bold"}], "]"}], "]"}], ";", "\n",
             "    ", 
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"\[CapitalSigma]", "+", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"i", "=", "1"}], "nO"], 
                  RowBox[{
                   UnderoverscriptBox["\[Sum]", 
                    RowBox[{"cd", "=", "1"}], "nVVt"], 
                   FractionBox[
                    RowBox[{
                    RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "i", ",", "cd"}], 
                    "\[RightDoubleBracket]"}]}], 
                    RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}], "+", 
                 RowBox[{
                  UnderoverscriptBox["\[Sum]", 
                   RowBox[{"a", "=", 
                    RowBox[{"nO", "+", "1"}]}], "nBas"], 
                  RowBox[{
                   UnderoverscriptBox["\[Sum]", 
                    RowBox[{"kl", "=", "1"}], "nOOt"], 
                   FractionBox[
                    RowBox[{
                    RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                    RowBox[{"p", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}], 
                    RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                    RowBox[{"q", ",", "a", ",", "kl"}], 
                    "\[RightDoubleBracket]"}]}], 
                    RowBox[{
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "p", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{
                    "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                    RowBox[{
                    "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}], "+", 
                    RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]]}]}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"p", ",", "nBas"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"q", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
            "    ", 
            RowBox[{"\[CapitalSigma]", "=", 
             RowBox[{"Re", "[", 
              RowBox[{
               FractionBox["1", "2"], 
               RowBox[{"(", 
                RowBox[{"\[CapitalSigma]", "+", 
                 RowBox[{"\[CapitalSigma]", "\[Transpose]"}]}], ")"}]}], 
              "]"}]}], ";"}]}], "\n", "  ", "]"}], ";", "\n", "  ", "\n", 
         "  ", 
         RowBox[{"(*", 
          RowBox[{
          "Galitskii", " ", "Migdal", " ", "correlation", " ", "energy"}], 
          "*)"}], "\n", "  ", 
         RowBox[{"EcGM", "=", 
          RowBox[{"EcGM", "+", 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], "nO"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"j", "=", "1"}], "nO"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"cd", "=", "1"}], "nVVt"], 
              FractionBox[
               RowBox[{
                SuperscriptBox[
                 RowBox[{"\[Rho]1t", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", "j", ",", "cd"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "+", 
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]1t", "\[LeftDoubleBracket]", "cd", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]]}]}]}], "-", 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"a", "=", 
              RowBox[{"nO", "+", "1"}]}], "nBas"], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"b", "=", 
               RowBox[{"nO", "+", "1"}]}], "nBas"], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"kl", "=", "1"}], "nOOt"], 
              FractionBox[
               RowBox[{
                SuperscriptBox[
                 RowBox[{"\[Rho]2t", "\[LeftDoubleBracket]", 
                  RowBox[{"a", ",", "b", ",", "kl"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                   "\[RightDoubleBracket]"}], "+", 
                  RowBox[{
                  "\[Epsilon]GT", "\[LeftDoubleBracket]", "b", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], 
               RowBox[{
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{
                   "\[Epsilon]GT", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "\[CapitalOmega]2t", "\[LeftDoubleBracket]", "kl", 
                    "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
                SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}]}], ";", "\n", "\n", 
         "  ", 
         RowBox[{"(*", 
          RowBox[{"Self", "-", 
           RowBox[{"Energy", " ", "in", " ", "AO", " ", "basis"}]}], "*)"}], 
         "\n", "  ", 
         RowBox[{"\[CapitalSigma]", "=", 
          RowBox[{"S", ".", "cGT", ".", "\[CapitalSigma]", ".", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"S", ".", "cGT"}], ")"}], "\[Transpose]"}]}]}], ";", 
         "\n", "\n", "  ", 
         RowBox[{"(*", " ", 
          RowBox[{"Fock", " ", "matrix", " ", "in", " ", "AO", " ", "basis"}],
           "*)"}], "\n", "  ", 
         RowBox[{"FOA", " ", "=", " ", 
          RowBox[{"Hcore", " ", "+", " ", "J", " ", "-", " ", 
           RowBox[{"0.5", "K"}], "+", " ", "\[CapitalSigma]"}]}], ";", " ", 
         "\n", "\n", "  ", 
         RowBox[{"error", "=", 
          RowBox[{
           RowBox[{"FOA", ".", "P", ".", "S"}], "-", "S", "-", 
           RowBox[{"P", ".", "FOA"}]}]}], ";", "\n", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{"DIISEx", ",", "\n", "    ", 
           RowBox[{
            RowBox[{"NotebookEvaluate", "[", 
             RowBox[{"path", "<>", "\"\</src/utils/DIIS.nb\>\""}], "]"}], ";",
             "\n", "    ", 
            RowBox[{"nDIIS", "=", 
             RowBox[{"Min", "[", 
              RowBox[{
               RowBox[{"nDIIS", "+", "1"}], ",", "maxDIIS"}], "]"}]}], ";", 
            "\n", "    ", 
            RowBox[{"error", "=", 
             RowBox[{"Flatten", "[", "error", "]"}]}], ";", "\n", "    ", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"tmpF", ",", "tmpErrorDIIS", ",", "FOA"}], "}"}], "=", 
             RowBox[{"DIIS", "[", 
              RowBox[{"nBasSq", ",", "nBasSq", ",", "nDIIS", ",", 
               RowBox[{
                RowBox[{"Take", "[", 
                 RowBox[{
                  RowBox[{"eDIIS", "\[Transpose]"}], ",", "nDIIS"}], "]"}], 
                "\[Transpose]"}], ",", 
               RowBox[{
                RowBox[{"Take", "[", 
                 RowBox[{
                  RowBox[{"FDIIS", "\[Transpose]"}], ",", "nDIIS"}], "]"}], 
                "\[Transpose]"}], ",", "error", ",", "FOA"}], "]"}]}], ";", 
            "\n", "    ", 
            RowBox[{
             RowBox[{"eDIIS", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", 
               RowBox[{"1", ";;", "nDIIS"}]}], "\[RightDoubleBracket]"}], "=", 
             RowBox[{"tmpErrorDIIS", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", 
               RowBox[{"1", ";;", "nDIIS"}]}], "\[RightDoubleBracket]"}]}], 
            ";", "\n", "    ", 
            RowBox[{
             RowBox[{"FDIIS", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", 
               RowBox[{"1", ";;", "nDIIS"}]}], "\[RightDoubleBracket]"}], "=", 
             RowBox[{"tmpF", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", 
               RowBox[{"1", ";;", "nDIIS"}]}], "\[RightDoubleBracket]"}]}], 
            ";"}]}], "\n", "  ", "]"}], ";", "\n", "  ", "\n", "  ", 
         RowBox[{"FOA", "=", 
          RowBox[{"ArrayReshape", "[", 
           RowBox[{"FOA", ",", 
            RowBox[{"{", 
             RowBox[{"nBas", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", "  ",
          "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{
          "Fock", " ", "matrix", " ", "in", " ", "orthogonal", " ", "basis"}],
           "*)"}], "\n", "  ", 
         RowBox[{"Fp", "=", " ", 
          RowBox[{
           RowBox[{"X", "\[Transpose]"}], ".", "FOA", ".", "X"}]}], ";", " ", 
         
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"F", "'"}], "=", 
           RowBox[{
            SuperscriptBox["X", "\[Dagger]"], ".", "F", ".", "X"}]}], "*)"}], 
         "\n", "\n", "  ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"\[Epsilon]GT", ",", "cpGT"}], "}"}], "=", " ", 
          RowBox[{"SortEigensystem", "[", 
           RowBox[{"Eigensystem", "[", "Fp", "]"}], "]"}]}], ";", " ", 
         RowBox[{"cpGT", "=", 
          RowBox[{"cpGT", "\[Transpose]"}]}], ";", "\n", "\n", "  ", 
         RowBox[{"cGT", "=", " ", 
          RowBox[{"X", ".", "cpGT"}]}], ";", " ", 
         RowBox[{"(*", 
          RowBox[{"C", "=", 
           RowBox[{"X", ".", 
            RowBox[{"C", "'"}]}]}], "*)"}], " ", 
         RowBox[{"Orb", "=", 
          RowBox[{
           RowBox[{"Take", "[", 
            RowBox[{
             RowBox[{"cGT", "\[Transpose]"}], ",", 
             RowBox[{"Nelc", "/", "2"}]}], "]"}], "\[Transpose]"}]}], ";", 
         "\n", "  ", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{"Back", "-", 
           RowBox[{"Transform", " ", "the", " ", "Self"}], "-", 
           RowBox[{"Energy", " ", "in", " ", "MO", " ", "basis"}]}], "*)"}], 
         "\n", "  ", 
         RowBox[{"\[CapitalSigma]", " ", "=", " ", 
          RowBox[{
           RowBox[{"cGT", "\[Transpose]"}], ".", "\[CapitalSigma]", ".", 
           "cGT"}]}], ";", " ", "\n", "\n", "  ", 
         RowBox[{"(*", 
          RowBox[{
          "Density", " ", "matrix", " ", "in", " ", "AO", " ", "basis"}], 
          "*)"}], "\n", "  ", 
         RowBox[{"P", " ", "=", " ", 
          RowBox[{"2", 
           RowBox[{"Orb", ".", 
            RowBox[{"Orb", "\[Transpose]"}]}]}]}], ";", "\n", "\n", "  ", 
         RowBox[{"conv", "=", 
          RowBox[{"Max", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{"\[Epsilon]GT", "-", "oldEigenvalues"}], "]"}], "]"}]}], 
         ";", 
         RowBox[{"Print", "[", "conv", "]"}], ";", "\n", "\n", "  ", 
         RowBox[{"oldEigenvalues", " ", "=", " ", "\[Epsilon]GT"}], ";", " ", 
         "\n", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"nSCF", "\[Equal]", "maxSCF"}], ",", 
           RowBox[{
            RowBox[{"Print", "[", 
             RowBox[{"Style", "[", 
              RowBox[{
              "\"\<Convergence failed for qsGT!\>\"", ",", "Red", ",", 
               "Bold"}], "]"}], "]"}], ";", 
            RowBox[{"Break", "[", "]"}]}]}], "]"}], ";"}]}], "\n", "\n", 
       "]"}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"qsGW", " ", "kinetic", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"qsGET", "=", 
       RowBox[{"Tr", "[", 
        RowBox[{"P", ".", "T"}], "]"}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"qsGW", " ", "Nuclear", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"qsGEV", "=", 
       RowBox[{"Tr", "[", 
        RowBox[{"P", ".", "V"}], "]"}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"qsGW", " ", "Coulomb", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"qsGEJ", "=", " ", 
       RowBox[{"0.5", 
        RowBox[{"Tr", "[", 
         RowBox[{"P", ".", "J"}], "]"}]}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"Exchange", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"qsGEK", "=", " ", 
       RowBox[{
        RowBox[{"-", "0.25"}], 
        RowBox[{"Tr", "[", 
         RowBox[{"P", ".", "K"}], "]"}]}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"Compute", " ", "EcppRPA"}], "*)"}], "\n", 
      RowBox[{"ispin", "=", "3"}], ";", "\n", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas", ",", "nO", ",", "nV", ",", "nOOs", ",", "nVVs", ",", "ERIGT", 
         ",", "\[Epsilon]GT", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", "\n", 
      RowBox[{"EcppRPAab", "=", 
       RowBox[{"linearppquantities", "[", "\"\<EcppRPA\>\"", "]"}]}], ";", 
      "\n", "\n", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", 
      RowBox[{"linearppquantities", "=", 
       RowBox[{"linearpp", "[", 
        RowBox[{
        "nBas", ",", "nO", ",", "nV", ",", "nOOt", ",", "nVVt", ",", "ERIGT", 
         ",", "\[Epsilon]GT", ",", "ispin", ",", "TDAT"}], "]"}]}], ";", "\n", 
      RowBox[{"EcppRPAaa", "=", 
       RowBox[{"linearppquantities", "[", "\"\<EcppRPA\>\"", "]"}]}], ";", 
      "\n", "\n", 
      RowBox[{"EcppRPAab", "=", 
       RowBox[{"EcppRPAab", "-", "EcppRPAaa"}]}], ";", "\n", 
      RowBox[{"EcppRPAaa", "=", 
       RowBox[{"3", "EcppRPAaa"}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"qsGW", " ", "electronic", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"EqsG", " ", "=", " ", 
         RowBox[{
         "qsGET", " ", "+", " ", "qsGEV", " ", "+", " ", "qsGEJ", " ", "+", 
          " ", "qsGEK", " ", "+", " ", "EcppRPAab", "+", "EcppRPAaa"}]}], 
        ";"}], "*)"}], "\n", 
      RowBox[{"EqsG", " ", "=", " ", 
       RowBox[{
       "qsGET", " ", "+", " ", "qsGEV", " ", "+", " ", "qsGEJ", " ", "+", " ",
         "qsGEK", " ", "+", " ", "EcGM"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "  ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GT/print_qsGT.nb\>\""}], "]"}], ";",
          "\n", "  ", 
         RowBox[{"TabqsGT", "=", 
          RowBox[{"PrintQsGT", "[", 
           RowBox[{"nO", ",", "\[Epsilon]", ",", 
            RowBox[{"Diagonal", "[", "\[CapitalSigma]", "]"}], ",", 
            "\[Epsilon]GT", ",", "ENuc", ",", "ERHF", ",", 
            RowBox[{"EcppRPAaa", "+", "EcppRPAab"}], ",", "EcGM"}], "]"}]}], 
         ";", "\n", "  ", 
         RowBox[{"Print", "[", "TabqsGT", "]"}], ";"}]}], "\n", "]"}], ";", 
      "\n", "\n", 
      RowBox[{"qsGTquantities", "=", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<EcqsGT\>\"", "\[Rule]", 
          RowBox[{"EcppRPAab", "+", "EcppRPAaa"}]}], ",", 
         RowBox[{"\"\<EqsG\>\"", "\[Rule]", "EqsG"}]}], "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"nSCF", "\[Equal]", "maxSCF"}], ",", 
        RowBox[{"Return", "[", "]"}], ",", 
        RowBox[{"Return", "[", "qsGTquantities", "]"}]}], "]"}]}]}], "]"}]}], 
  ";"}]], "Code",
 CellChangeTimes->{{3.8412907360509768`*^9, 3.841290767352318*^9}, {
   3.841290852021455*^9, 3.841291088936771*^9}, {3.8412911960967703`*^9, 
   3.841291280028779*^9}, {3.841291383212871*^9, 3.841291423275309*^9}, {
   3.841291547288528*^9, 3.841291582612652*^9}, {3.841291621367841*^9, 
   3.841291799151053*^9}, {3.841293404270245*^9, 3.8412934381021338`*^9}, {
   3.841294190793131*^9, 3.841294190932802*^9}, {3.841723341810753*^9, 
   3.841723369603565*^9}, {3.8417258777516212`*^9, 3.841725888483293*^9}, {
   3.841740739684051*^9, 3.841740803394528*^9}, {3.841742057746941*^9, 
   3.84174206243566*^9}, {3.841804265669832*^9, 3.841804291877537*^9}, {
   3.841804335051078*^9, 3.841804549791407*^9}, {3.841804583679954*^9, 
   3.841804677771634*^9}, {3.841804746017061*^9, 3.841804861116322*^9}, 
   3.841804904016964*^9, {3.8418050174046783`*^9, 3.841805195332254*^9}, {
   3.841805253157311*^9, 3.841805328394299*^9}, {3.841806325662134*^9, 
   3.841806339631695*^9}, {3.8418067066666803`*^9, 3.841806708967476*^9}, {
   3.841806845837481*^9, 3.841806847324267*^9}, {3.841807052323201*^9, 
   3.8418070794966516`*^9}, {3.8418071482045717`*^9, 3.841807156815271*^9}, {
   3.841807199151353*^9, 3.841807245656597*^9}, {3.841807303899704*^9, 
   3.841807355284751*^9}, {3.8418073903369226`*^9, 3.84180739540488*^9}, {
   3.841807574432432*^9, 3.841807597350506*^9}, 3.8418093742386007`*^9, {
   3.841809410463296*^9, 3.841809417767693*^9}, {3.841809454138961*^9, 
   3.841809454241062*^9}, {3.841809578244854*^9, 3.841809580292478*^9}, {
   3.841810285465267*^9, 3.841810344654068*^9}, {3.841810671772352*^9, 
   3.841810671842416*^9}, {3.8418112541676826`*^9, 3.841811289705542*^9}, {
   3.841811442987988*^9, 3.8418114465113983`*^9}, {3.841891239385508*^9, 
   3.8418912733231993`*^9}, 3.8418914146474*^9, {3.841891770538907*^9, 
   3.841891776707958*^9}, {3.84189187968594*^9, 3.8418918797755013`*^9}, {
   3.8418920628601723`*^9, 3.841892063173448*^9}, {3.8418935710965033`*^9, 
   3.8418935905161743`*^9}, {3.8418954917031517`*^9, 3.841895501182172*^9}, {
   3.841896438961976*^9, 3.841896443779167*^9}, {3.8418971951161947`*^9, 
   3.841897195293405*^9}, {3.841898007511718*^9, 3.841898014874379*^9}, {
   3.841898166771308*^9, 3.841898168029125*^9}, {3.841909913342054*^9, 
   3.841909921831612*^9}, {3.841912236232272*^9, 3.841912239512827*^9}, {
   3.841912371095286*^9, 3.841912382857003*^9}, {3.84191301680661*^9, 
   3.8419130384418287`*^9}, {3.841913265768181*^9, 3.841913266685586*^9}, {
   3.8419791706169243`*^9, 3.841979200949822*^9}, {3.841979351847752*^9, 
   3.84197935228951*^9}, {3.8419794559974203`*^9, 3.8419794667621527`*^9}, {
   3.8419797903553257`*^9, 3.841979799795072*^9}, {3.84197999189287*^9, 
   3.841979994007091*^9}, {3.841980078544078*^9, 3.8419800904445333`*^9}, {
   3.841980454148156*^9, 3.8419804610470943`*^9}, {3.841981458555045*^9, 
   3.841981468907381*^9}, {3.841981546105423*^9, 3.84198155481328*^9}, {
   3.841985032279896*^9, 3.841985032643393*^9}, {3.84198524176471*^9, 
   3.841985246155397*^9}, {3.841985280265856*^9, 3.841985280477169*^9}, {
   3.843125073582367*^9, 3.8431250758743477`*^9}, {3.84415475477244*^9, 
   3.844154760387919*^9}, {3.844154821626107*^9, 3.84415486070291*^9}, {
   3.84415490999039*^9, 3.844154913893703*^9}, {3.8441549793635902`*^9, 
   3.84415497995866*^9}, {3.84415513441611*^9, 3.8441551374579287`*^9}, {
   3.8441552571943293`*^9, 3.8441552778933477`*^9}, {3.844155324414474*^9, 
   3.8441553392828493`*^9}, {3.844155978750801*^9, 3.84415598106925*^9}, {
   3.8441561696169*^9, 3.8441561829399023`*^9}, {3.844156238908268*^9, 
   3.844156271466123*^9}, 3.8441563421155233`*^9, {3.844156493975095*^9, 
   3.8441565061493587`*^9}, {3.847856768535904*^9, 3.847856783039447*^9}, {
   3.8478617991951227`*^9, 3.847861813272704*^9}, {3.847861928494488*^9, 
   3.8478619380513678`*^9}, {3.847861979948945*^9, 3.8478620014664392`*^9}, {
   3.847862037997295*^9, 3.8478620451330147`*^9}, {3.84839595497173*^9, 
   3.848395985405437*^9}, {3.848396043959331*^9, 3.8483960832736692`*^9}, {
   3.8483961661604652`*^9, 3.848396202494219*^9}, 3.848396375888668*^9, {
   3.848396493326457*^9, 3.848396524384718*^9}, {3.848408565921213*^9, 
   3.848408592778236*^9}, 3.848409172622566*^9, {3.84871765235371*^9, 
   3.8487177617337933`*^9}, {3.848717873701322*^9, 3.848717974408823*^9}, {
   3.848718025527466*^9, 3.848718066657596*^9}, 3.848718119426331*^9, {
   3.8487201128502197`*^9, 3.848720173008923*^9}, {3.848726019712656*^9, 
   3.8487260267616653`*^9}, {3.850269329458132*^9, 3.850269329698752*^9}, {
   3.8502749204270477`*^9, 3.850274943985931*^9}, 3.850275403595583*^9, {
   3.8502755132575893`*^9, 3.850275546654352*^9}, {3.8502756959725533`*^9, 
   3.8502757036917458`*^9}, {3.850276206866992*^9, 3.850276220202824*^9}, 
   3.850276344776451*^9, {3.85027648512656*^9, 3.850276514515409*^9}, {
   3.8502765806991243`*^9, 3.850276630763526*^9}, {3.850276693032634*^9, 
   3.850276696362136*^9}, {3.8502767619146757`*^9, 3.850276762051947*^9}, {
   3.85027684007679*^9, 3.8502768629981318`*^9}, {3.8502772360749197`*^9, 
   3.850277243093083*^9}, {3.850277306065991*^9, 3.850277311854795*^9}, {
   3.850277768395309*^9, 3.850277775685998*^9}, {3.850278095000217*^9, 
   3.85027809600953*^9}, {3.850278160868586*^9, 3.8502781627791348`*^9}, {
   3.850278256987073*^9, 3.8502782616964273`*^9}, {3.850278322934794*^9, 
   3.850278323034729*^9}, {3.8502783911372137`*^9, 3.850278417981995*^9}, {
   3.8502785511657333`*^9, 3.850278553858448*^9}, {3.850278879638178*^9, 
   3.850278886069046*^9}, {3.850279007514284*^9, 3.850279012593256*^9}, {
   3.850279157012236*^9, 3.850279193308311*^9}, {3.8502797817554903`*^9, 
   3.8502797857467203`*^9}, {3.850290656229433*^9, 3.850290659299768*^9}, {
   3.850290845764166*^9, 3.850290900766048*^9}, {3.850291093518087*^9, 
   3.850291101874687*^9}, {3.85029124822815*^9, 3.8502912523506527`*^9}, {
   3.8502913046549187`*^9, 3.8502913099701633`*^9}, {3.850291340005107*^9, 
   3.8502913424756804`*^9}, {3.850291415525779*^9, 3.850291425359748*^9}, {
   3.850291540242951*^9, 3.850291554004156*^9}, {3.850292242798184*^9, 
   3.85029229012916*^9}, {3.8502934808145237`*^9, 3.850293517264257*^9}, {
   3.850293646088225*^9, 3.850293650650454*^9}, {3.850305291476993*^9, 
   3.850305291694573*^9}, {3.850305455526206*^9, 3.85030545760506*^9}, {
   3.850356384686133*^9, 3.850356392750008*^9}, {3.85035652196625*^9, 
   3.850356559212977*^9}, {3.850356872447381*^9, 3.850356934910523*^9}, {
   3.850356991013183*^9, 3.8503569978661423`*^9}, {3.850357132051198*^9, 
   3.850357188996697*^9}, {3.850357292224187*^9, 3.8503572931926737`*^9}, {
   3.850357397929653*^9, 3.850357411880081*^9}, 3.850357498898899*^9, {
   3.850366039544341*^9, 3.850366039721738*^9}, {3.85036623520315*^9, 
   3.850366237030425*^9}, 3.85036656573046*^9, {3.850373292598187*^9, 
   3.850373376244619*^9}, {3.8504674556052427`*^9, 3.850467498212208*^9}, {
   3.850467897452539*^9, 3.8504679004909782`*^9}, {3.850467984637779*^9, 
   3.850468003411252*^9}, {3.850477191720716*^9, 3.850477193352227*^9}, 
   3.850477259494253*^9, {3.850530879734247*^9, 3.850530882147949*^9}, {
   3.8510757886111403`*^9, 3.851075826529358*^9}, {3.851075864920271*^9, 
   3.851075919968951*^9}, {3.898647442717471*^9, 3.8986474719830027`*^9}, {
   3.8986476996330748`*^9, 3.8986478172397833`*^9}, {3.898648346732316*^9, 
   3.89864839016229*^9}, {3.898648422984437*^9, 3.8986484843084593`*^9}, {
   3.898648661009635*^9, 3.898648682618174*^9}, {3.898649026129475*^9, 
   3.8986492473000193`*^9}, {3.898649280592249*^9, 3.898649395036591*^9}, {
   3.898649615314341*^9, 3.89864963934461*^9}, {3.898649679025931*^9, 
   3.898649708193459*^9}, {3.898650230129635*^9, 3.8986502541543694`*^9}, {
   3.898650706382958*^9, 3.898650721053512*^9}, {3.898652377077038*^9, 
   3.8986524212629967`*^9}, {3.898652454714156*^9, 3.8986524942616158`*^9}, {
   3.898652828194195*^9, 3.898652981677806*^9}, {3.898653035377742*^9, 
   3.89865318494538*^9}, {3.898653318061727*^9, 3.898653450823214*^9}, {
   3.8986541092733383`*^9, 3.8986541419474783`*^9}, {3.89865614664645*^9, 
   3.898656156942341*^9}, {3.898656245365934*^9, 3.898656264231822*^9}, {
   3.8986564436694937`*^9, 3.898656444353071*^9}, {3.898656560788067*^9, 
   3.898656561247642*^9}, {3.898657189980144*^9, 3.89865720272466*^9}, {
   3.8986603401454906`*^9, 3.898660343648787*^9}, 3.898660431353797*^9, {
   3.898660541001598*^9, 3.898660557575757*^9}, 3.898660752850348*^9, {
   3.8986614307910137`*^9, 3.898661434021056*^9}, {3.8986617184959908`*^9, 
   3.89866172490819*^9}, 
   3.898662031213797*^9},ExpressionUUID->"6c7dae4f-c421-45d9-8928-\
96b3add2e3ab"]
}, Open  ]]
},
WindowSize->{1020, 714},
WindowMargins->{{Automatic, 82}, {Automatic, 30}},
Magnification:>1.25 Inherited,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (June 19, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"21c779ad-d217-4e36-9971-d260a129feea"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 147, 3, 123, "Title",ExpressionUUID->"f989f59e-4a40-4b13-b87b-bee6ba3f3de0"],
Cell[730, 27, 2085, 46, 474, "Code",ExpressionUUID->"fe89e349-cd95-4e7a-896c-34a7cdbf6edb"]
}, Open  ]],
Cell[CellGroupData[{
Cell[2852, 78, 160, 3, 123, "Title",ExpressionUUID->"fbee2e4f-cfe4-4130-b014-86f702c106aa"],
Cell[3015, 83, 841, 20, 162, "Code",ExpressionUUID->"98df1992-addd-4dd1-aba4-2b19b4f68520"]
}, Closed]],
Cell[CellGroupData[{
Cell[3893, 108, 161, 3, 89, "Title",ExpressionUUID->"3c304a8a-200b-466d-8c7c-8d29120f259d"],
Cell[4057, 113, 51756, 1098, 5197, "Code",ExpressionUUID->"6c7dae4f-c421-45d9-8928-96b3add2e3ab"]
}, Open  ]]
}
]
*)

