(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     34721,        810]
NotebookOptionsPosition[     34024,        790]
NotebookOutlinePosition[     34448,        807]
CellTagsIndexPosition[     34405,        804]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"G0F2", "[", 
   RowBox[{
   "nBas_", ",", "nO_", ",", "nV_", ",", "eHF_", ",", "ERI_", ",", "ENuc_", 
    ",", "ERHF_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\n", 
     RowBox[{"regularizermethod", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Option", " ", "to", " ", "choose", " ", "the", " ", "regularizer", 
        " ", "of", " ", "quasiparticle", " ", "equations"}], " ", "*)"}], 
      "\n", "s", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Value", " ", "of", " ", "the", " ", "regularizer", " ", "parameter"}],
        " ", "*)"}], "\n", "\[Eta]", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Value", " ", "of", " ", "the", " ", "broadening", " ", "imaginary", 
        " ", "constant"}], " ", "*)"}], "\n", "lin", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"Don", "'"}], "t", " ", "solve", " ", "the", " ", "nonlinear",
         " ", "qp", " ", "equation", " ", "and", " ", "use", " ", 
        "approximate", " ", "linearized", " ", "qp", " ", "energies"}], " ", 
       "*)"}], "\n", "regularizerorbital", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Regularizer", " ", "for", " ", "the", " ", "static", " ", "part"}], 
       " ", "*)"}], "\n", "regularizerselfenergy", ",", " ", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Regularizer", " ", "for", " ", "the", " ", "dynamic", " ", "part"}], 
       " ", "*)"}], "\n", "outputsGF2"}], "}"}], ",", "\n", "\n", 
    RowBox[{
     RowBox[{"regularizermethod", " ", "=", " ", 
      RowBox[{"options", "[", 
       RowBox[{"[", "\"\<MBPT_regularizer_methods\>\"", "]"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"s", " ", "=", " ", 
      RowBox[{"options", "[", 
       RowBox[{"[", "\"\<MBPT_regularizer_value\>\"", "]"}], "]"}]}], ";", 
     "\n", 
     RowBox[{"lin", " ", "=", " ", 
      RowBox[{
      "options", "\[LeftDoubleBracket]", "\"\<linearized\>\"", 
       "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Eta]", " ", "=", " ", 
      RowBox[{
      "options", "\[LeftDoubleBracket]", "\"\<\[Eta]\>\"", 
       "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", "\n", 
     RowBox[{
      RowBox[{"regularizerorbital", "[", "\[CapitalDelta]_", "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", "\n", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
           RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
           RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
           RowBox[{"Return", "[", 
            RowBox[{"Exp", "[", 
             RowBox[{
              RowBox[{"-", "2"}], "s", " ", 
              SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}], "]"}]}], "]"}],
          ";"}]}], "\n", "]"}]}], ";", "\[IndentingNewLine]", "\n", 
     RowBox[{
      RowBox[{"regularizerselfenergy", "[", "\[CapitalDelta]_", "]"}], ":=", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", "\n", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
           RowBox[{"Return", "[", "1", "]"}]}], "]"}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
           RowBox[{"Return", "[", 
            RowBox[{"1", " ", "-", " ", 
             RowBox[{"Exp", "[", 
              RowBox[{
               RowBox[{"-", "2"}], "s", " ", 
               SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
          "]"}], ";", "\n", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
           RowBox[{"Return", "[", 
            RowBox[{"1", " ", "-", " ", 
             RowBox[{"Exp", "[", 
              RowBox[{
               RowBox[{"-", "2"}], "s", " ", 
               SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
          "]"}], ";"}]}], "\n", "]"}]}], ";", "\n", "\n", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"options", "[", "\"\<spinorbital\>\"", "]"}], "==", "True"}], 
       ",", "\n", "\t\t", 
       RowBox[{"outputsGF2", " ", "=", " ", 
        RowBox[{"spinorbG0F2", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "eHF", ",", "ERI", ",", "ENuc", 
          ",", "ERHF", ",", "\[Eta]", ",", "verbose", ",", "lin", ",", "s", 
          ",", "options", ",", "regularizerorbital", ",", 
          "regularizerselfenergy"}], "]"}]}], "\n", "\t", ",", 
       RowBox[{"(*", 
        RowBox[{"else", " ", "go", " ", "to", " ", "spatial"}], " ", "*)"}], 
       "\[IndentingNewLine]", "\t", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<Spatial orbital implementation of GF2 not yet available\>\"", 
         "]"}], ";"}]}], "\n", "\t\t", 
      RowBox[{"(*", 
       RowBox[{"outputsGF2", " ", "=", " ", 
        RowBox[{"spatialorbG0F2", "[", "]"}]}], "*)"}], "\n", "\t", "]"}], 
     ";", "\n", "\t", "\n", 
     RowBox[{"Return", "[", "outputsGF2", "]"}]}]}], "\n", "]"}]}]], "Code",
 CellChangeTimes->{{3.877680179723378*^9, 3.87768020172503*^9}, {
   3.877687960895183*^9, 3.87768803061088*^9}, {3.8776880681816*^9, 
   3.877688270429729*^9}, {3.8776885524318438`*^9, 3.877688632119705*^9}, {
   3.877688686185315*^9, 3.87768868861136*^9}, 3.8776890661705008`*^9, {
   3.877689597346311*^9, 3.877689697488616*^9}, {3.877689984714643*^9, 
   3.877689990834032*^9}, {3.877690318825542*^9, 3.8776903343120613`*^9}, {
   3.877690375186058*^9, 3.877690415230291*^9}, {3.878007047317452*^9, 
   3.878007047581683*^9}, {3.878007399745657*^9, 3.878007540440433*^9}, {
   3.878007622099257*^9, 3.878007644652177*^9}, 3.8780112529189873`*^9, {
   3.878026563668294*^9, 3.878026566148128*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"be91d493-19ce-4a16-83f6-affcdb4c3468"],

Cell[CellGroupData[{

Cell["Spin orbitals\t", "Title",
 CellChangeTimes->{{3.878006900414748*^9, 
  3.8780069108646507`*^9}},ExpressionUUID->"ab838407-d2cf-4002-b195-\
ee7d9e90a2db"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spinorbG0F2", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "\n", "       ", "ERHF_", ",", "\[Eta]_", ",", "verbose_", 
     ",", "lin_", ",", "s_", ",", "options_", ",", "regularizerorbital_", ",",
      "regularizerselfenergy_"}], "]"}], ":=", "\n", "       ", "\n", "  ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "\[CapitalSigma]x", ",", "\[CapitalSigma]c", ",", "Z", ",", 
       "d\[CapitalSigma]cd\[Omega]", ",", "soeG0F2", ",", "EcG0F2", ",", 
       "outputs", ",", "SelfEnergy", ",", "Im\[CapitalSigma]c\[Omega]", ",", 
       "\[CapitalSigma]c\[Omega]", ",", "Im\[CapitalSigma]c", ",", "\n", 
       "          ", "nBas2", ",", "so\[Epsilon]", ",", "soERI", ",", 
       "soeG0F2lin", ",", "IP", ",", "soeRenorm", ",", "TabG0F2"}], "}"}], 
     ",", "\n", "\n", "    ", 
     RowBox[{"(*", 
      RowBox[{"Spatial", " ", "to", " ", "spin", " ", "orbitals"}], "*)"}], 
     "\n", "    ", 
     RowBox[{
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{
       "path", "<>", "\"\</src/utils/spatial_to_spin_MO_energy.nb\>\""}], 
       "]"}], ";", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/utils/spatial_to_spin_ERI.nb\>\""}], 
       "]"}], ";", "\n", "\n", "    ", 
      RowBox[{"so\[Epsilon]", " ", "=", " ", 
       RowBox[{"SpatialToSpinMOEnergy", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]"}], "]"}]}], 
      ";", "\n", "    ", 
      RowBox[{"soERI", " ", "=", " ", 
       RowBox[{"SpatialToSpinERI", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "ERI"}], "]"}]}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Anti", "-", 
        RowBox[{"symmetrized", " ", "ERIs"}]}], "*)"}], "\n", "    ", 
      RowBox[{"soERI", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"soERI", "\[LeftDoubleBracket]", 
           RowBox[{"p", ",", "q", ",", "r", ",", "t"}], 
           "\[RightDoubleBracket]"}], "-", 
          RowBox[{"soERI", "\[LeftDoubleBracket]", 
           RowBox[{"p", ",", "q", ",", "t", ",", "r"}], 
           "\[RightDoubleBracket]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", 
           RowBox[{"2", "nBas"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"q", ",", 
           RowBox[{"2", "nBas"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"r", ",", 
           RowBox[{"2", "nBas"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"t", ",", 
           RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"soeG0F2", " ", "=", " ", "so\[Epsilon]"}], ";", "\n", "    ", 
      "\n", "    ", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", "    ", "\n", "    ", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"so\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           FractionBox["1", "2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"j", "=", "1"}], 
              RowBox[{"2", "nO"}]], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"a", "=", 
                RowBox[{
                 RowBox[{"2", "nO"}], "+", "1"}]}], 
               RowBox[{"2", "nBas"}]], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"soERI", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "a", ",", "i", ",", "j"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerorbital", "[", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}]}], ";", "\n", "    ", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"soeRenorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           FractionBox["1", "2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{
                RowBox[{"2", "nO"}], "+", "1"}]}], 
              RowBox[{"2", "nBas"}]], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"b", "=", 
                RowBox[{
                 RowBox[{"2", "nO"}], "+", "1"}]}], 
               RowBox[{"2", "nBas"}]], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"soERI", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "i", ",", "a", ",", "b"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerorbital", "[", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}]}], ";", "\n", "\t", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"Re", "[", "soeRenorm", "]"}]}], ";", "\n", "\n", "\t", 
      RowBox[{"(*", 
       RowBox[{"Self", " ", "energy"}], "*)"}], "\n", "\t", 
      RowBox[{"\[CapitalSigma]c\[Omega]", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          FractionBox["1", "2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], 
            RowBox[{"2", "nO"}]], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"j", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{
                RowBox[{"2", "nO"}], "+", "1"}]}], 
              RowBox[{"2", "nBas"}]], 
             RowBox[{
              FractionBox[
               SuperscriptBox[
                RowBox[{"soERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "i", ",", "j"}], 
                 "\[RightDoubleBracket]"}], "2"], 
               RowBox[{"\[Omega]", "+", 
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
              RowBox[{"regularizerselfenergy", "[", 
               RowBox[{
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", 
           RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}], ";", "\n", "\t", 
      RowBox[{"\[CapitalSigma]c\[Omega]", "=", 
       RowBox[{"\[CapitalSigma]c\[Omega]", "+", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           FractionBox["1", "2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{
                RowBox[{"2", "nO"}], "+", "1"}]}], 
              RowBox[{"2", "nBas"}]], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"b", "=", 
                RowBox[{
                 RowBox[{"2", "nO"}], "+", "1"}]}], 
               RowBox[{"2", "nBas"}]], 
              RowBox[{
               FractionBox[
                SuperscriptBox[
                 RowBox[{"soERI", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "i", ",", "a", ",", "b"}], 
                  "\[RightDoubleBracket]"}], "2"], 
                RowBox[{"\[Omega]", "+", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}]}], ";", "\n", "\t", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", "\[CapitalSigma]c\[Omega]", "]"}]}], ";", "\n", 
      "\t", "\n", "\t", "\n", "\t", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "soeRenorm", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}], "]"}]}], ";", "\n", "\t",
       "\n", "\t", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], " ", "*)"}], "\n", "\t", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          FractionBox["1", "2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], 
            RowBox[{"2", "nO"}]], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"j", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{
                RowBox[{"2", "nO"}], "+", "1"}]}], 
              RowBox[{"2", "nBas"}]], 
             RowBox[{
              FractionBox[
               RowBox[{"-", 
                SuperscriptBox[
                 RowBox[{"soERI", "\[LeftDoubleBracket]", 
                  RowBox[{"p", ",", "a", ",", "i", ",", "j"}], 
                  "\[RightDoubleBracket]"}], "2"]}], 
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{"\[Omega]", "+", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
              RowBox[{"regularizerselfenergy", "[", 
               RowBox[{
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "so\[Epsilon]", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", 
           RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}], ";", "\n", "\t", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           FractionBox["1", "2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"i", "=", "1"}], 
             RowBox[{"2", "nO"}]], 
            RowBox[{
             UnderoverscriptBox["\[Sum]", 
              RowBox[{"a", "=", 
               RowBox[{
                RowBox[{"2", "nO"}], "+", "1"}]}], 
              RowBox[{"2", "nBas"}]], 
             RowBox[{
              UnderoverscriptBox["\[Sum]", 
               RowBox[{"b", "=", 
                RowBox[{
                 RowBox[{"2", "nO"}], "+", "1"}]}], 
               RowBox[{"2", "nBas"}]], 
              RowBox[{
               FractionBox[
                RowBox[{"-", 
                 SuperscriptBox[
                  RowBox[{"soERI", "\[LeftDoubleBracket]", 
                   RowBox[{"p", ",", "i", ",", "a", ",", "b"}], 
                   "\[RightDoubleBracket]"}], "2"]}], 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{"\[Omega]", "+", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}], "+", 
                   RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
               RowBox[{"regularizerselfenergy", "[", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                    "\[RightDoubleBracket]"}], "-", 
                   RowBox[{
                   "so\[Epsilon]", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}]}]}]}]}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}]}], ";", "\n", "\t", 
      "\n", "\t", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "d\[CapitalSigma]cd\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"2", "nBas"}]}], "}"}]}], "]"}], "]"}]}], ";", "\n", "\t", 
      RowBox[{"Z", " ", "=", " ", 
       FractionBox["1", 
        RowBox[{"1", "-", "d\[CapitalSigma]cd\[Omega]"}]]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"(*", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"soeG0F2lin", " ", "=", " ", 
       RowBox[{"soeRenorm", " ", "+", " ", 
        RowBox[{"Z", "*", "\[CapitalSigma]c"}]}]}], " ", ";", "\n", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "    ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", " ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}]}], "]"}], ";", "\n", "      ", 
         RowBox[{"soeG0F2", " ", "=", " ", "soeG0F2lin"}]}], ",", "\n", 
        "      ", "\n", "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", " ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}]}], "]"}], ";", "\n", "      ", 
         RowBox[{"soeG0F2", " ", "=", " ", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"FindRoot", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "soeRenorm", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Omega]", ",", 
                 RowBox[{
                 "soeG0F2lin", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], "}"}]}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", 
              RowBox[{"2", "nBas"}]}], "}"}]}], "]"}]}], ";"}]}], "\n", 
       "      ", "\n", "    ", "]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], "*)"}], "\n", 
      "    ", 
      RowBox[{"IP", "=", 
       RowBox[{
        RowBox[{"Max", "[", 
         RowBox[{"Select", "[", 
          RowBox[{"soeG0F2", ",", 
           RowBox[{
            RowBox[{"#", "<", "0"}], " ", "&"}]}], "]"}], "]"}], "*", 
        "HaToeV"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/MP/MP2.nb\>\""}], "]"}], ";", "\n", 
      "    ", 
      RowBox[{"EcG0F2", " ", "=", " ", 
       RowBox[{"MP2", "[", 
        RowBox[{"nBas", ",", "nO", ",", "ERI", ",", 
         RowBox[{"soeG0F2", "[", 
          RowBox[{"[", 
           RowBox[{";;", ";;", "2"}], "]"}], "]"}], ",", "options"}], "]"}]}],
       ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Print", " ", "outputs"}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GF/print_G0F2.nb\>\""}], "]"}], ";",
          "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0F2 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"TabG0F2", " ", "=", " ", 
          RowBox[{"PrintG0F2", "[", 
           RowBox[{
           "nO", ",", "so\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",", 
            "soeG0F2", ",", "ENuc", ",", "ERHF", ",", "EcG0F2"}], "]"}]}], 
         ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabG0F2", "]"}], ";"}]}], "\n", "    ", "]"}],
       ";", "\n", "\n", "    ", 
      RowBox[{"outputs", " ", "=", " ", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<EcMP2\>\"", "\[Rule]", "EcG0F2"}], ",", 
         RowBox[{"\"\<soeG0F2\>\"", "\[Rule]", "soeG0F2"}], ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}]}], "]"}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"Return", "[", "outputs", "]"}]}]}], "\n", "  ", "]"}]}], 
  ";"}]], "Code",
 CellChangeTimes->{{3.872844083344153*^9, 3.8728441243136063`*^9}, {
   3.8728442240926228`*^9, 3.8728443414287043`*^9}, {3.8728443855675373`*^9, 
   3.872844446715354*^9}, {3.8728444837849913`*^9, 3.872844516930936*^9}, {
   3.8728445698996677`*^9, 3.872844576105318*^9}, {3.872844704874819*^9, 
   3.872844710494471*^9}, {3.872844760437141*^9, 3.872844842687961*^9}, {
   3.872845414669299*^9, 3.872845453560335*^9}, {3.872845684022779*^9, 
   3.872845684170787*^9}, {3.872845809562683*^9, 3.8728458139930964`*^9}, {
   3.8728458498635197`*^9, 3.872845867401936*^9}, {3.872845916883953*^9, 
   3.8728459178661757`*^9}, {3.872845951400909*^9, 3.872846012839258*^9}, {
   3.872846094734322*^9, 3.872846096558745*^9}, {3.8728461322756233`*^9, 
   3.8728462411865187`*^9}, 3.872846539812138*^9, {3.872846626559691*^9, 
   3.872846629047997*^9}, {3.872846923916967*^9, 3.8728469243123703`*^9}, {
   3.872846988503901*^9, 3.872846988641983*^9}, 3.872847039330594*^9, {
   3.872908376348083*^9, 3.872908377815778*^9}, {3.8735199206947317`*^9, 
   3.873519961079748*^9}, {3.8735199930332527`*^9, 3.8735202147493057`*^9}, {
   3.8735202470979958`*^9, 3.873520258247385*^9}, {3.8735203168293037`*^9, 
   3.8735203601875467`*^9}, {3.8735206598769608`*^9, 3.873520788453281*^9}, {
   3.87352084268828*^9, 3.873520877096634*^9}, {3.873520909654594*^9, 
   3.873521010243105*^9}, {3.873537699428405*^9, 3.873537712206647*^9}, 
   3.873537849501217*^9, {3.8735379063461027`*^9, 3.873538003131442*^9}, {
   3.873538067593025*^9, 3.8735381834890013`*^9}, {3.873538299005363*^9, 
   3.87353832771821*^9}, {3.876386099139866*^9, 3.8763861713297863`*^9}, {
   3.876386203644589*^9, 3.876386322224472*^9}, {3.876386493610466*^9, 
   3.876386497192384*^9}, {3.876389296933138*^9, 3.876389466904985*^9}, {
   3.876389505799872*^9, 3.876389514777108*^9}, {3.8763904509398527`*^9, 
   3.8763906180779533`*^9}, {3.876390669293137*^9, 3.876390703312484*^9}, {
   3.8763911788337927`*^9, 3.876391202819601*^9}, {3.876391316203471*^9, 
   3.876391328413418*^9}, {3.876391375817774*^9, 3.876391384414813*^9}, {
   3.876391475160351*^9, 3.876391538839696*^9}, 3.876906529455852*^9, {
   3.8769065880263987`*^9, 3.876906589329658*^9}, {3.877075938395946*^9, 
   3.8770759445204897`*^9}, {3.8770762670964947`*^9, 3.877076351523572*^9}, {
   3.877688265712512*^9, 3.877688352762135*^9}, {3.877688521072369*^9, 
   3.877688521958202*^9}, {3.877688643875822*^9, 3.877688667220685*^9}, {
   3.87768898382051*^9, 3.877689041434021*^9}, {3.877689091267583*^9, 
   3.877689113249461*^9}, 3.877689146021433*^9, {3.877689230014827*^9, 
   3.8776892867130823`*^9}, {3.8776894143639803`*^9, 3.877689528697596*^9}, 
   3.877689589436741*^9, {3.87768963797936*^9, 3.877689644533412*^9}, 
   3.877689676605206*^9, {3.878008284848724*^9, 3.878008287215217*^9}, {
   3.8780089614602613`*^9, 3.8780090320647917`*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"6def1ead-9d11-4736-a756-0c94ad97d530"]
}, Open  ]],

Cell["Spatial orbitals", "Title",
 CellChangeTimes->{{3.8780069122740307`*^9, 
  3.8780069148011*^9}},ExpressionUUID->"07f71bfa-ca04-40d7-9caf-583f479af977"]
},
WindowSize->{932.25, 1032.},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
Magnification:>1.25 Inherited,
FrontEndVersion->"13.1 for Linux x86 (64-bit) (June 16, 2022)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"e257cd5e-b224-4d74-b90f-4ad9455cfc4a"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 6343, 142, 936, "Code",ExpressionUUID->"be91d493-19ce-4a16-83f6-affcdb4c3468"],
Cell[CellGroupData[{
Cell[6926, 166, 160, 3, 122, "Title",ExpressionUUID->"ab838407-d2cf-4002-b195-ee7d9e90a2db"],
Cell[7089, 171, 26759, 612, 2060, "Code",ExpressionUUID->"6def1ead-9d11-4736-a756-0c94ad97d530"]
}, Open  ]],
Cell[33863, 786, 157, 2, 122, "Title",ExpressionUUID->"07f71bfa-ca04-40d7-9caf-583f479af977"]
}
]
*)

