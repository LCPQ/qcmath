(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     16718,        371]
NotebookOptionsPosition[     16339,        356]
NotebookOutlinePosition[     16763,        373]
CellTagsIndexPosition[     16720,        370]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"soG0W0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "nS_", ",", "\[Epsilon]_", ",", 
     "ERI_", ",", "ENuc_", ",", "ERHF_", ",", "TDA_", ",", "BSE_", ",", "\n", 
     "       ", "W_", ",", "TDAW_", ",", "\[Eta]_", ",", "Regularized_", ",", 
     "\[Kappa]_", ",", "verbose_", ",", "lin_"}], "]"}], ":=", "\n", "\n", 
   "  ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "\n", "           ", 
      RowBox[{
      "ispin", ",", "dRPA", ",", "linearquantities", ",", "sERI", ",", 
       "\[CapitalOmega]", ",", "\[CapitalSigma]x", ",", "\[CapitalSigma]c", 
       ",", "EcGM", ",", "Z", ",", "\n", "           ", "soG0W0quantities", 
       ",", "EcRPA", ",", "SelfEnergyquantities", ",", "\n", "           ", 
       "SelfEnergyquantities\[Omega]", ",", "eG0W0NL", ",", 
       "\[CapitalSigma]c\[Omega]", ",", "SelfEnergyquantitiesIm", ",", "\n", 
       "           ", "Re\[CapitalSigma]c", ",", "Im\[CapitalSigma]c", ",", 
       "Im\[CapitalSigma]c\[Omega]", ",", "nBas2", ",", "nO2", ",", "nV2", 
       ",", "nS2", ",", "so\[Epsilon]", ",", "soERI", ",", "soeG0W0", ",", 
       "\n", "           ", "TabG0W0", ",", "IP", ",", "soeG0W0lin"}], "\n", 
      "         ", "}"}], ",", "\n", "         ", "\n", "    ", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"TDA", "\[Equal]", "True"}], ",", 
          RowBox[{
          "Print", "[", "\"\<Tamm-Dancoff approximation activated !\>\"", 
           "]"}]}], "]"}]}], "\n", "    ", "]"}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"TDAW", "\[Equal]", "True"}], ",", 
          RowBox[{
          "Print", "[", 
           "\"\<Tamm-Dancoff approximation for dynamic screening !\>\"", 
           "]"}]}], "]"}]}], "\n", "    ", "]"}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"(*", 
       RowBox[{"Define", " ", "the", " ", "spaces"}], "*)"}], "\n", "    ", 
      RowBox[{"nBas2", "=", 
       RowBox[{"2", "nBas"}]}], ";", "\n", "    ", 
      RowBox[{"nO2", "=", 
       RowBox[{"2", "nO"}]}], ";", "\n", "    ", 
      RowBox[{"nV2", "=", 
       RowBox[{"2", "nV"}]}], ";", "\n", "    ", 
      RowBox[{"nS2", "=", 
       RowBox[{"nO2", "*", "nV2"}]}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Spatial", " ", "to", " ", "spin", " ", "orbitals"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{
       "path", "<>", "\"\</src/utils/spatial_to_spin_MO_energy.nb\>\""}], 
       "]"}], ";", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/utils/spatial_to_spin_ERI.nb\>\""}], 
       "]"}], ";", "\n", "    ", 
      RowBox[{"so\[Epsilon]", "=", 
       RowBox[{"SpatialToSpinMOEnergy", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]"}], "]"}]}], 
      ";", "\n", "    ", 
      RowBox[{"soERI", "=", 
       RowBox[{"SpatialToSpinERI", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "ERI"}], "]"}]}], ";", 
      "\n", "\n", "    ", 
      RowBox[{"dRPA", "=", "True"}], ";", "\n", "    ", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/LR/linear_Response.nb\>\""}], "]"}], 
      ";", "\n", "    ", 
      RowBox[{"linearquantities", "=", 
       RowBox[{"LinearResponse", "[", 
        RowBox[{
        "nBas2", ",", "nO2", ",", "nV2", ",", "so\[Epsilon]", ",", "soERI", 
         ",", "TDAW", ",", "ispin", ",", "dRPA"}], "]"}]}], ";", "\n", "    ", 
      RowBox[{"sERI", "=", 
       RowBox[{"linearquantities", "[", "\"\<sERI\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"\[CapitalOmega]", "=", 
       RowBox[{"linearquantities", "[", "\"\<\[CapitalOmega]\>\"", "]"}]}], 
      ";", "\n", "\n", "    ", 
      RowBox[{"soeG0W0", "=", "so\[Epsilon]"}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"Regularized", " ", "Self"}], "-", "Energy"}], ",", " ", 
        RowBox[{"Z", " ", "and", " ", "EcGM"}]}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Regularized", "\[Equal]", "True"}], ",", "\n", "    ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{"Print", "[", "\"\<Regularized self energy !\>\"", "]"}], 
            ";"}]}], "  ", "\n", "      ", "]"}], ";", "\n", "      ", "\n", 
         "      ", 
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{
          "path", "<>", "\"\</src/GW/regularized_self_energy_diag.nb\>\""}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"SelfEnergyquantities", "=", 
          RowBox[{"soRegularizedSelfEnergyGWdiag", "[", 
           RowBox[{
           "nBas2", ",", "nO2", ",", "nV2", ",", "nS2", ",", "so\[Epsilon]", 
            ",", "sERI", ",", "\[CapitalOmega]", ",", "\[Kappa]"}], "]"}]}], 
         ";"}], "\n", "      ", "\n", "      ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "      ", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GW/self_energy_diag_so.nb\>\""}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"SelfEnergyquantities", "=", 
          RowBox[{"soSelfEnergyGWdiag", "[", 
           RowBox[{
           "nBas2", ",", "nO2", ",", "nV2", ",", "nS2", ",", "so\[Epsilon]", 
            ",", "sERI", ",", "\[CapitalOmega]", ",", "\[Eta]"}], "]"}]}], 
         ";"}]}], "\n", "      ", "\n", "    ", "]"}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{
       "SelfEnergyquantities", "[", "\"\<\[CapitalSigma]c\>\"", "]"}]}], ";", 
      "\n", "    ", 
      RowBox[{"Z", " ", "=", " ", 
       RowBox[{"SelfEnergyquantities", "[", "\"\<Z\>\"", "]"}]}], ";", "\n", 
      "    ", 
      RowBox[{"EcGM", " ", "=", " ", 
       RowBox[{"SelfEnergyquantities", "[", "\"\<EcGM\>\"", "]"}]}], ";", 
      "\n", "    ", "\n", "    ", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/utils/extract_self_energy.nb\>\""}], 
       "]"}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"SelfEnergyquantities", " ", "=", " ", 
       RowBox[{"exctractSelfEnergy", "[", 
        RowBox[{"nBas2", ",", "\[CapitalSigma]c", ",", "Z", ",", "soeG0W0"}], 
        "]"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{
       "SelfEnergyquantities", "[", "\"\<\[CapitalSigma]c\[Omega]\>\"", 
        "]"}]}], ";", "\n", "    ", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{
       "SelfEnergyquantities", "[", "\"\<\[CapitalSigma]c\>\"", "]"}]}], ";", 
      "\n", "    ", 
      RowBox[{"Z", " ", "=", " ", 
       RowBox[{"SelfEnergyquantities", "[", "\"\<Z\>\"", "]"}]}], ";", "\n", 
      "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], "*)"}], 
      "\n", "    ", 
      RowBox[{"soeG0W0lin", " ", "=", " ", 
       RowBox[{"so\[Epsilon]", " ", "+", " ", 
        RowBox[{"Z", "*", "\[CapitalSigma]c"}]}]}], ";", "\n", "    ", "\n", 
      "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "    ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{"soeG0W0", "=", "soeG0W0lin"}]}], ",", "\n", "      ", "\n", 
        "      ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "        ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}]}], "\n", "      ", "]"}], ";", "\n", "      ", "\n",
          "      ", 
         RowBox[{"soeG0W0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"FindRoot", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Omega]", ",", 
                 RowBox[{
                 "soeG0W0lin", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], "}"}]}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";"}]}], "\n", 
       "      ", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"soeG0W0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"NSolve", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", "\[Omega]"}], "]"}]}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";"}], "*)"}], 
       "\n", "    ", "]"}], ";", "\n", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], "*)"}], "\n", 
      "    ", 
      RowBox[{"IP", "=", 
       RowBox[{
        RowBox[{"Max", "[", 
         RowBox[{"Select", "[", 
          RowBox[{"soeG0W0", ",", 
           RowBox[{
            RowBox[{"#", "<", "0"}], " ", "&"}]}], "]"}], "]"}], "*", 
        "HaToeV"}]}], ";", "\n", "    ", "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"RPA", " ", "correlation", " ", "energy"}], "*)"}], "\n", 
      "    ", 
      RowBox[{"linearquantities", "=", 
       RowBox[{"LinearResponse", "[", 
        RowBox[{
        "nBas2", ",", "nO2", ",", "nV2", ",", "soeG0W0", ",", "soERI", ",", 
         "TDAW", ",", "ispin", ",", "dRPA"}], "]"}]}], ";", "\n", "\n", 
      "    ", 
      RowBox[{"EcRPA", "=", 
       RowBox[{"linearquantities", "[", "\"\<Ec\>\"", "]"}]}], ";", "\n", 
      "\n", "    ", 
      RowBox[{"(*", 
       RowBox[{"Print", " ", "outputs"}], "*)"}], "\n", "    ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "      ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GW/print_G0W0.nb\>\""}], "]"}], ";",
          "\n", "      ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0W0 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "      ", 
         RowBox[{"TabG0W0", "=", 
          RowBox[{"PrintG0W0", "[", 
           RowBox[{
           "nO2", ",", "so\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",",
             "soeG0W0", ",", "ENuc", ",", "ERHF", ",", "EcRPA", ",", "EcGM"}],
            "]"}]}], ";", "\n", "      ", 
         RowBox[{"Print", "[", "TabG0W0", "]"}], ";"}]}], "\n", "    ", "]"}],
       ";", "\n", "\n", "    ", 
      RowBox[{"soG0W0quantities", "=", 
       RowBox[{"Association", "[", "\n", "                       ", 
        RowBox[{
         RowBox[{"\"\<soeG0W0\>\"", "\[Rule]", "soeG0W0"}], ",", 
         RowBox[{"\"\<EcGM\>\"", "\[Rule]", "EcGM"}], ",", 
         RowBox[{"\"\<EcRPA\>\"", "\[Rule]", "EcRPA"}], ",", 
         RowBox[{"\"\<Z\>\"", "\[Rule]", "Z"}], ",", 
         RowBox[{"\"\<\[CapitalSigma]c\>\"", "\[Rule]", "\[CapitalSigma]c"}], 
         ",", 
         RowBox[{
         "\"\<\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "\[CapitalSigma]c\[Omega]"}], ",", "\n", "                       ", 
         
         RowBox[{
         "\"\<Re\[CapitalSigma]c\>\"", "\[Rule]", "Re\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\>\"", "\[Rule]", "Im\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "Im\[CapitalSigma]c\[Omega]"}], ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}]}], "\n", 
        "                     ", "]"}]}], ";", "\n", "                     ", 
      "\n", "    ", 
      RowBox[{"Return", "[", "soG0W0quantities", "]"}]}]}], "\n", "  ", 
    "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.872304078546926*^9, 3.872304400280061*^9}, {
   3.872304470530682*^9, 3.8723044827388897`*^9}, {3.8723046228111897`*^9, 
   3.872304623987451*^9}, {3.872304663603607*^9, 3.8723046798560534`*^9}, {
   3.8723047122705383`*^9, 3.872304746808969*^9}, {3.872304840215445*^9, 
   3.8723048494611187`*^9}, {3.872305073572164*^9, 3.872305078447076*^9}, {
   3.872305168503766*^9, 3.872305180624424*^9}, {3.87230527779624*^9, 
   3.872305282384562*^9}, {3.872305405396117*^9, 3.872305430688628*^9}, {
   3.8723055252073927`*^9, 3.872305532914448*^9}, {3.872305653329393*^9, 
   3.872305658274475*^9}, {3.87230596508256*^9, 3.872305969992448*^9}, {
   3.8723061254614973`*^9, 3.872306129760983*^9}, 3.8723080590359*^9, {
   3.8723084666552963`*^9, 3.872308489413369*^9}, {3.8723087813088017`*^9, 
   3.872308788441601*^9}, {3.872308833752603*^9, 3.872308845860911*^9}, 
   3.8723089986442223`*^9, 3.872309165137309*^9, {3.8727394420803633`*^9, 
   3.872739469074233*^9}, {3.872739891943796*^9, 3.872739892617156*^9}, {
   3.8727418815922127`*^9, 3.872741994389845*^9}, {3.872742282230216*^9, 
   3.872742291838263*^9}, {3.872742442205216*^9, 3.8727424664112883`*^9}, {
   3.872751177271284*^9, 3.87275118275002*^9}, {3.872835418412024*^9, 
   3.8728354190832043`*^9}, {3.872835477340548*^9, 3.872835484992189*^9}, {
   3.872835539930642*^9, 3.872835561748478*^9}, {3.8728356142286997`*^9, 
   3.87283563685604*^9}, {3.872835696743266*^9, 3.8728357157164917`*^9}, 
   3.872835785237009*^9, {3.8728359268572702`*^9, 3.872835938277602*^9}, 
   3.872838974121212*^9, {3.872839689649723*^9, 3.872839701408535*^9}, {
   3.873426509752775*^9, 3.873426534830405*^9}, {3.873426683579526*^9, 
   3.873426683766387*^9}, {3.873426756957799*^9, 3.873427094243403*^9}, {
   3.8735253631607018`*^9, 3.87352538610562*^9}, {3.873525437497962*^9, 
   3.873525522861841*^9}, {3.873525556370843*^9, 3.873525705721744*^9}, {
   3.8735257439965982`*^9, 3.873525804583519*^9}, {3.8735260366074963`*^9, 
   3.873526041524048*^9}, {3.87352621969032*^9, 3.873526252578394*^9}, 
   3.873526367280805*^9, {3.873527258248994*^9, 3.873527457584656*^9}, {
   3.8735276322081947`*^9, 3.873527644940772*^9}, {3.8735277627011747`*^9, 
   3.873527786223406*^9}, {3.873527956654313*^9, 3.873527958179574*^9}, {
   3.8737674349855137`*^9, 3.8737674419903727`*^9}, {3.873767603481275*^9, 
   3.8737676271054068`*^9}},ExpressionUUID->"8f24aa16-b83d-4d9f-9113-\
bd22d9a64c20"]
},
WindowSize->{1272, 679},
WindowMargins->{{82, Automatic}, {50, Automatic}},
Magnification:>1.5 Inherited,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (June 19, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"09f0b617-356e-406d-9e23-deb0628a0611"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 15777, 334, 3298, "Code",ExpressionUUID->"8f24aa16-b83d-4d9f-9113-bd22d9a64c20"]
}
]
*)

