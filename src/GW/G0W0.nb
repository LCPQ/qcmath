(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     72306,       1637]
NotebookOptionsPosition[     71294,       1610]
NotebookOutlinePosition[     71774,       1628]
CellTagsIndexPosition[     71731,       1625]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["G0W0", "Title",
 CellChangeTimes->{{3.898140117111072*^9, 
  3.8981401184215183`*^9}},ExpressionUUID->"7f9779b4-c01e-428c-a258-\
d6634f96cf06"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"G0W0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "options_", ",", "verbose_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "\n", 
      RowBox[{"regularizermethod", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Option", " ", "to", " ", "choose", " ", "the", " ", "regularizer", 
         " ", "of", " ", "quasiparticle", " ", "equations"}], " ", "*)"}], 
       "\n", "s", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Value", " ", "of", " ", "the", " ", "regularizer", " ", 
         "parameter"}], " ", "*)"}], "\n", "\[Eta]", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Value", " ", "of", " ", "the", " ", "broadening", " ", "imaginary", 
         " ", "constant"}], " ", "*)"}], "\n", "lin", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"Don", "'"}], "t", " ", "solve", " ", "the", " ", 
         "nonlinear", " ", "qp", " ", "equation", " ", "and", " ", "use", " ",
          "approximate", " ", "linearized", " ", "qp", " ", "energies"}], " ",
         "*)"}], "\n", "regularizerorbital", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Regularizer", " ", "for", " ", "the", " ", "static", " ", "part"}], 
        " ", "*)"}], "\n", "regularizerselfenergy", ",", " ", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Regularizer", " ", "for", " ", "the", " ", "dynamic", " ", "part"}], 
        " ", "*)"}], "\n", "TDA", ",", "\n", "TDAW", ",", "\n", 
       "outputsG0W0"}], "}"}], ",", "\n", "         ", "\n", 
     RowBox[{
      RowBox[{"regularizermethod", " ", "=", " ", 
       RowBox[{"options", "[", "\"\<MBPT_regularizer_methods\>\"", "]"}]}], 
      ";", "\n", 
      RowBox[{"s", " ", "=", " ", 
       RowBox[{"options", "[", "\"\<MBPT_regularizer_value\>\"", "]"}]}], ";",
       "\n", "        ", "\n", 
      RowBox[{
       RowBox[{"regularizerorbital", "[", "\[CapitalDelta]_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", "\n", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
            RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
            RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"Exp", "[", 
              RowBox[{
               RowBox[{"-", "2"}], "s", " ", 
               SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}], "]"}]}], 
           "]"}], ";"}]}], "\n", "]"}]}], ";", "\n", "\n", 
      RowBox[{
       RowBox[{"regularizerselfenergy", "[", "\[CapitalDelta]_", "]"}], ":=", 
       
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", "\n", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "None"}], ",", " ", 
            RowBox[{"Return", "[", "1", "]"}]}], "]"}], ";", "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<MonLoo\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"1", " ", "-", " ", 
              RowBox[{"Exp", "[", 
               RowBox[{
                RowBox[{"-", "2"}], "s", " ", 
                SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
           "]"}], ";", "\n", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"regularizermethod", "==", "\"\<SRG\>\""}], ",", " ", 
            RowBox[{"Return", "[", 
             RowBox[{"1", " ", "-", " ", 
              RowBox[{"Exp", "[", 
               RowBox[{
                RowBox[{"-", "2"}], "s", " ", 
                SuperscriptBox["\[CapitalDelta]", "2"]}], "]"}]}], "]"}]}], 
           "]"}], ";"}]}], "\n", "]"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"options", "[", "\"\<spinorbital\>\"", "]"}], "==", "True"}],
         ",", "\n", "\n", "  ", 
        RowBox[{
         RowBox[{"outputsG0W0", "=", " ", 
          RowBox[{"spinorbG0W0", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]", ",", "ERI", ",", 
            "ENuc", ",", "ERHF", ",", "options", ",", "verbose", ",", 
            "regularizerorbital", ",", "regularizerselfenergy"}], "]"}]}], 
         ";"}], "\n", "  ", "\n", "  ", ",", 
        RowBox[{"(*", 
         RowBox[{"else", " ", "go", " ", "to", " ", "spatial"}], " ", "*)"}], 
        "\n", "  ", "\n", "  ", 
        RowBox[{
         RowBox[{"outputsG0W0", " ", "=", " ", 
          RowBox[{"spatialorbG0W0", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]", ",", "ERI", ",", 
            "ENuc", ",", "ERHF", ",", "options", ",", "verbose", ",", 
            "regularizerorbital", ",", "regularizerselfenergy"}], "]"}]}], 
         ";"}]}], "\n", "  ", "]"}], ";", "\n", "  ", "\n", 
      RowBox[{"Return", "[", "outputsG0W0", "]"}], ";"}]}], "\n", "]"}]}], 
  ";"}]], "Code",
 CellChangeTimes->{{3.872304078546926*^9, 3.872304400280061*^9}, {
   3.872304470530682*^9, 3.8723044827388897`*^9}, {3.8723046228111897`*^9, 
   3.872304623987451*^9}, {3.872304663603607*^9, 3.8723046798560534`*^9}, {
   3.8723047122705383`*^9, 3.872304746808969*^9}, {3.872304840215445*^9, 
   3.8723048494611187`*^9}, {3.872305073572164*^9, 3.872305078447076*^9}, {
   3.872305168503766*^9, 3.872305180624424*^9}, {3.87230527779624*^9, 
   3.872305282384562*^9}, {3.872305405396117*^9, 3.872305430688628*^9}, {
   3.8723055252073927`*^9, 3.872305532914448*^9}, {3.872305653329393*^9, 
   3.872305658274475*^9}, {3.87230596508256*^9, 3.872305969992448*^9}, {
   3.8723061254614973`*^9, 3.872306129760983*^9}, 3.8723080590359*^9, {
   3.8723084666552963`*^9, 3.872308489413369*^9}, {3.8723087813088017`*^9, 
   3.872308788441601*^9}, {3.872308833752603*^9, 3.872308845860911*^9}, 
   3.8723089986442223`*^9, 3.872309165137309*^9, {3.8727394420803633`*^9, 
   3.872739469074233*^9}, {3.872739891943796*^9, 3.872739892617156*^9}, {
   3.8727418815922127`*^9, 3.872741994389845*^9}, {3.872742282230216*^9, 
   3.872742291838263*^9}, {3.872742442205216*^9, 3.8727424664112883`*^9}, {
   3.872751177271284*^9, 3.87275118275002*^9}, {3.872835418412024*^9, 
   3.8728354190832043`*^9}, {3.872835477340548*^9, 3.872835484992189*^9}, {
   3.872835539930642*^9, 3.872835561748478*^9}, {3.8728356142286997`*^9, 
   3.87283563685604*^9}, {3.872835696743266*^9, 3.8728357157164917`*^9}, 
   3.872835785237009*^9, {3.8728359268572702`*^9, 3.872835938277602*^9}, 
   3.872838974121212*^9, {3.872839689649723*^9, 3.872839701408535*^9}, {
   3.873426509752775*^9, 3.873426534830405*^9}, {3.873426683579526*^9, 
   3.873426683766387*^9}, {3.873426756957799*^9, 3.873427094243403*^9}, {
   3.8735253631607018`*^9, 3.87352538610562*^9}, {3.873525437497962*^9, 
   3.873525522861841*^9}, {3.873525556370843*^9, 3.873525705721744*^9}, {
   3.8735257439965982`*^9, 3.873525804583519*^9}, {3.8735260366074963`*^9, 
   3.873526041524048*^9}, {3.87352621969032*^9, 3.873526252578394*^9}, 
   3.873526367280805*^9, {3.873527258248994*^9, 3.873527457584656*^9}, {
   3.8735276322081947`*^9, 3.873527644940772*^9}, {3.8735277627011747`*^9, 
   3.873527786223406*^9}, {3.873527956654313*^9, 3.873527958179574*^9}, {
   3.8737674349855137`*^9, 3.8737674419903727`*^9}, {3.873767603481275*^9, 
   3.8737676271054068`*^9}, {3.8769058757818747`*^9, 3.876905879960346*^9}, {
   3.87690597098145*^9, 3.876906055402425*^9}, {3.87690610851334*^9, 
   3.876906149210267*^9}, {3.876906202850963*^9, 3.876906212530003*^9}, {
   3.876906274275639*^9, 3.876906483797546*^9}, {3.876906526036331*^9, 
   3.876906592570251*^9}, {3.87690838588911*^9, 3.8769084377766733`*^9}, {
   3.876908489092997*^9, 3.876908510973881*^9}, {3.876970012040598*^9, 
   3.8769700314916563`*^9}, {3.876970146109022*^9, 3.876970156307208*^9}, 
   3.876970200427124*^9, {3.876970244719307*^9, 3.87697036073313*^9}, {
   3.8769705197708893`*^9, 3.876970522646799*^9}, 3.8769715713924923`*^9, 
   3.8769718285708227`*^9, {3.8769719143750343`*^9, 3.876971952615879*^9}, 
   3.876972467106173*^9, {3.876972708382388*^9, 3.876972718983923*^9}, {
   3.877074641012545*^9, 3.877074645093155*^9}, {3.8780068720783052`*^9, 
   3.8780068722857847`*^9}, {3.878007062308545*^9, 3.87800706910168*^9}, {
   3.878007653477775*^9, 3.87800765908747*^9}, {3.878007767522791*^9, 
   3.87800796541908*^9}, {3.878008059305562*^9, 3.87800811235816*^9}, {
   3.8780081847200737`*^9, 3.8780082401334057`*^9}, {3.878009364797697*^9, 
   3.878009391484429*^9}, {3.878009427254616*^9, 3.8780094287476273`*^9}, {
   3.8780104147402353`*^9, 3.878010446897237*^9}, 3.87801123829215*^9, {
   3.8780116019827833`*^9, 3.878011607266671*^9}, {3.8780119688603287`*^9, 
   3.878011972707088*^9}, 3.878022743838328*^9, {3.878023259634087*^9, 
   3.8780233360994177`*^9}, {3.878026512766728*^9, 3.878026515201621*^9}, {
   3.878361006879678*^9, 3.8783610310574713`*^9}, {3.8783610641018887`*^9, 
   3.878361080563999*^9}, {3.878376903719801*^9, 3.878377017984702*^9}, {
   3.878377132732438*^9, 3.8783772172323847`*^9}, {3.8783772621410017`*^9, 
   3.878377271313507*^9}, {3.878377340371727*^9, 3.878377376344967*^9}, {
   3.878377437039953*^9, 3.8783774382523127`*^9}, {3.8783775931042957`*^9, 
   3.878377604064275*^9}, {3.878377835663329*^9, 3.878377835823969*^9}, 
   3.878378413954343*^9, {3.878378491663618*^9, 3.878378521624255*^9}, {
   3.898140137753409*^9, 3.8981401659529867`*^9}, {3.8981402052673483`*^9, 
   3.898140263751646*^9}, {3.898140374422243*^9, 3.8981403771903152`*^9}, {
   3.8981416282739353`*^9, 3.8981416288000507`*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"6852136e-0b70-41bd-acc9-006c0f21877f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spin orbitals", "Title",
 CellChangeTimes->{{3.8780069962396603`*^9, 
  3.8780070009043303`*^9}},ExpressionUUID->"005e9ac3-9f38-4b4f-a064-\
2192e1577188"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spinorbG0W0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "options_", ",", "verbose_", ",", 
     "regularizerorbital_", ",", "regularizerselfenergy_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\n", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "lin", ",", "\[Eta]", ",", "nBas2", ",", "nO2", ",", "nV2", ",", "TDA", 
       ",", "TDAW", ",", "nS", ",", "ispin", ",", "dRPA", ",", 
       "linearquantities", ",", "sERI", ",", "\[CapitalOmega]", ",", 
       "\[CapitalSigma]x", ",", "\[CapitalSigma]c", ",", "EcGM", ",", "Z", 
       ",", "soG0W0quantities", ",", "EcRPA", ",", "SelfEnergyquantities", 
       ",", "\n", "SelfEnergyquantities\[Omega]", ",", 
       "\[CapitalSigma]c\[Omega]", ",", "SelfEnergyquantitiesIm", ",", 
       "Re\[CapitalSigma]c", ",", "Im\[CapitalSigma]c", ",", 
       "Im\[CapitalSigma]c\[Omega]", ",", "so\[Epsilon]", ",", "soERI", ",", 
       "soeG0W0", ",", "TabG0W0", ",", "IP", ",", "soeG0W0lin", ",", 
       "soeRenorm", ",", "d\[CapitalSigma]cd\[Omega]", ",", "XpY", ",", "\n", 
       "time"}], "}"}], ",", "\n", "           ", "\n", 
     RowBox[{"(*", " ", "options", " ", "*)"}], "           ", "\n", 
     RowBox[{
      RowBox[{"lin", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<linearized\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"\[Eta]", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<\[Eta]\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"TDA", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"TDAW", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA_GW\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"BSE", " ", "=", " ", 
         RowBox[{
         "options", "\[LeftDoubleBracket]", "\"\<BSE\>\"", 
          "\[RightDoubleBracket]"}]}], ";", "\n", 
        RowBox[{"dBSE", " ", "=", " ", 
         RowBox[{
         "options", "\[LeftDoubleBracket]", "\"\<dBSE\>\"", 
          "\[RightDoubleBracket]"}]}], ";", "\n", 
        RowBox[{"dTDA", " ", "=", " ", 
         RowBox[{
         "options", "\[LeftDoubleBracket]", "\"\<dTDA\>\"", 
          "\[RightDoubleBracket]"}]}], ";"}], "*)"}], "\n", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Define", " ", "spaces"}], "*)"}], "\n", 
      RowBox[{"nBas2", "=", 
       RowBox[{"2", "nBas"}]}], ";", "\n", 
      RowBox[{"nO2", "=", 
       RowBox[{"2", "nO"}]}], ";", "\n", 
      RowBox[{"nV2", "=", 
       RowBox[{"2", "nV"}]}], ";", "\n", "\n", 
      RowBox[{"nS", "=", 
       RowBox[{"nO2", "*", "nV2"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", "\"\<Tamm-Dancoff approximation activated !\>\"", 
            "]"}]}], "]"}], ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAW", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", 
            "\"\<Tamm-Dancoff approximation for dynamic screening !\>\"", 
            "]"}]}], "]"}], ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation activated !\>\"", "]"}]}], "]"}], 
         ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAW", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation for dynamic screening !\>\"", 
            "]"}]}], "]"}], ";"}]}], "\n", "]"}], ";", "\n", "\t", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Spatial", " ", "to", " ", "spin", " ", "orbitals"}], " ", 
       "*)"}], "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{
       "path", "<>", "\"\</src/utils/spatial_to_spin_MO_energy.nb\>\""}], 
       "]"}], ";", "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/utils/spatial_to_spin_ERI.nb\>\""}], 
       "]"}], ";", "\n", 
      RowBox[{"so\[Epsilon]", "=", 
       RowBox[{"SpatialToSpinMOEnergy", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]"}], "]"}]}], 
      ";", "\n", 
      RowBox[{"soERI", "=", 
       RowBox[{"SpatialToSpinERI", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nV", ",", "ERI"}], "]"}]}], ";", 
      "\n", "\n", 
      RowBox[{"dRPA", "=", "True"}], ";", "\n", 
      RowBox[{"ispin", "=", "4"}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<First RPA calculation...\>\"", "]"}], 
         ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{
         "PrintTemporary", "[", "\"\<First RPA calculation...\>\"", "]"}], 
         ";"}]}], "\n", "]"}], ";", "\n", "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/LR/linear_Response.nb\>\""}], "]"}], 
      ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearquantities"}], "}"}], "=", 
       RowBox[{"Timing", "[", 
        RowBox[{"LinearResponse", "[", 
         RowBox[{
         "nBas2", ",", "nO2", ",", "nV2", ",", "so\[Epsilon]", ",", "soERI", 
          ",", "TDAW", ",", "ispin", ",", "dRPA"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalOmega]", "=", 
       RowBox[{"linearquantities", "[", "\"\<\[CapitalOmega]\>\"", "]"}]}], 
      ";", "\n", 
      RowBox[{"XpY", "=", 
       RowBox[{"linearquantities", "[", "\"\<XpY\>\"", "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/GW/GW_excitation_density.nb\>\""}], 
       "]"}], ";", "\n", 
      RowBox[{"sERI", "=", 
       RowBox[{"GWExcitationDensity", "[", 
        RowBox[{"nBas2", ",", "nO2", ",", "nS", ",", "soERI", ",", "XpY"}], 
        "]"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"Print", "[", "\"\<Done !\>\"", "]"}], ";"}], "\n", "  ", 
        ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"PrintTemporary", "[", "\"\<Done !\>\"", "]"}], ";"}]}], 
       "\n", "]"}], ";", "\n", "\t", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"so\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"soeRenorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"soeRenorm", " ", "=", " ", 
       RowBox[{"Re", "[", "soeRenorm", "]"}]}], ";", "\n", "\t", "\n", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Self", " ", "energy"}], " ", "*)"}], "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"jb", "=", "1"}], "nS"], 
           RowBox[{
            FractionBox[
             SuperscriptBox[
              RowBox[{"sERI", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}], 
              "2"], 
             RowBox[{"\[Omega]", "-", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], " ", ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "a", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"], 
              RowBox[{"\[Omega]", "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", "\[CapitalSigma]c\[Omega]", "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], " ", "*)"}], "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO2"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"jb", "=", "1"}], "nS"], 
           RowBox[{
            FractionBox[
             RowBox[{"-", 
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"]}], 
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"\[Omega]", "-", 
                RowBox[{
                "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              RowBox[{"-", 
               SuperscriptBox[
                RowBox[{"sERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "jb"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{"\[Omega]", "-", 
                 RowBox[{
                 "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}]}], ";", "\n", "\t", 
      "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "d\[CapitalSigma]cd\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "so\[Epsilon]", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"Z", " ", "=", " ", 
       FractionBox["1", 
        RowBox[{"1", "-", "d\[CapitalSigma]cd\[Omega]"}]]}], ";", "\n", "\n", 
      
      RowBox[{"(*", " ", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], " ", 
       "*)"}], "\n", 
      RowBox[{"soeG0W0lin", " ", "=", " ", 
       RowBox[{"soeRenorm", " ", "+", " ", 
        RowBox[{"Z", "*", "\[CapitalSigma]c"}]}]}], ";", "\n", "    ", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}], "\n", "    ", ",", 
           RowBox[{"(*", "else", "*)"}], "\n", "    ", 
           RowBox[{
            RowBox[{
            "PrintTemporary", "[", 
             "\"\<QP energies obtained by linearization !\>\"", "]"}], 
            ";"}]}], "\n", "  ", "]"}], ";", "\n", "      ", "\n", 
         RowBox[{"soeG0W0", "=", "soeG0W0lin"}], ";"}], ",", "\n", "      ", 
        "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}], "\n", "    ", ",", 
           RowBox[{"(*", "else", "*)"}], "\n", "    ", 
           RowBox[{
            RowBox[{
            "PrintTemporary", "[", 
             "\"\<QP energies obtained by root search !\>\"", "]"}], ";"}]}], 
          "\n", "  ", "]"}], ";", "\n", "      ", "\n", "  ", 
         RowBox[{"soeG0W0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"FindRoot", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "soeRenorm", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Omega]", ",", 
                 RowBox[{
                 "soeRenorm", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], "}"}]}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas2"}], "}"}]}], "]"}]}], ";"}]}], "\n", 
       "\n", "]"}], ";", "\n", "\t", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], " ", "*)"}], 
      "\n", 
      RowBox[{"IP", "=", 
       RowBox[{
        RowBox[{
        "soeG0W0", "\[LeftDoubleBracket]", "nO2", "\[RightDoubleBracket]"}], 
        "*", "HaToeV"}]}], ";", "\n", "    ", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"RPA", " ", "correlation", " ", "energy"}], " ", "*)"}], "\n", 
      
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<Second RPA calculation...\>\"", "]"}], 
         ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{
         "PrintTemporary", "[", "\"\<Second RPA calculation...\>\"", "]"}], 
         ";"}]}], "\n", "]"}], ";", "\n", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearquantities"}], "}"}], "=", 
       RowBox[{"Timing", "[", 
        RowBox[{"LinearResponse", "[", 
         RowBox[{
         "nBas2", ",", "nO2", ",", "nV2", ",", "soeG0W0", ",", "soERI", ",", 
          "TDAW", ",", "ispin", ",", "dRPA"}], "]"}], "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"Print", "[", "\"\<Done !\>\"", "]"}], ";"}], "\n", "  ", 
        ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"PrintTemporary", "[", "\"\<Done !\>\"", "]"}], ";"}]}], 
       "\n", "]"}], ";", "\n", "\n", 
      RowBox[{"EcRPA", "=", 
       RowBox[{"linearquantities", "[", "\"\<Ec\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"GM", " ", "correlation", " ", "energy"}], " ", "*)"}], "\n", 
      RowBox[{"EcGM", "=", 
       RowBox[{
        UnderoverscriptBox["\[Sum]", 
         RowBox[{"i", "=", "1"}], "nO2"], 
        RowBox[{
         UnderoverscriptBox["\[Sum]", 
          RowBox[{"a", "=", 
           RowBox[{"nO2", "+", "1"}]}], "nBas2"], 
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"jb", "=", "1"}], "nS"], 
          FractionBox[
           RowBox[{
            SuperscriptBox[
             RowBox[{"sERI", "\[LeftDoubleBracket]", 
              RowBox[{"a", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}], 
             "2"], 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}]}], ")"}]}], 
           RowBox[{
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "so\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
            SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}], ";", "\n", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Print", " ", "outputs"}], " ", "*)"}], "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "  ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GW/print_G0W0.nb\>\""}], "]"}], ";",
          "\n", "  ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0W0 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "  ", 
         RowBox[{"TabG0W0", "=", 
          RowBox[{"PrintG0W0", "[", 
           RowBox[{
           "nO2", ",", "so\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",",
             "soeG0W0", ",", "ENuc", ",", "ERHF", ",", "EcRPA", ",", "EcGM"}],
            "]"}]}], ";", "\n", "  ", 
         RowBox[{"Print", "[", "TabG0W0", "]"}], ";"}]}], "\n", "]"}], ";", 
      "\n", "\n", 
      RowBox[{"soG0W0quantities", "=", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<soeG0W0\>\"", "\[Rule]", "soeG0W0"}], ",", 
         RowBox[{"\"\<EcGM\>\"", "\[Rule]", "EcGM"}], ",", 
         RowBox[{"\"\<EcRPA\>\"", "\[Rule]", "EcRPA"}], ",", 
         RowBox[{"\"\<Z\>\"", "\[Rule]", "Z"}], ",", 
         RowBox[{"\"\<\[CapitalSigma]c\>\"", "\[Rule]", "\[CapitalSigma]c"}], 
         ",", 
         RowBox[{
         "\"\<\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "\[CapitalSigma]c\[Omega]"}], ",", "\n", 
         "                             ", 
         RowBox[{
         "\"\<Re\[CapitalSigma]c\>\"", "\[Rule]", "Re\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\>\"", "\[Rule]", "Im\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "Im\[CapitalSigma]c\[Omega]"}], ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}]}], "]"}]}], ";", "\n", 
      "                     ", "\n", 
      RowBox[{"Return", "[", "soG0W0quantities", "]"}], ";"}]}], "\n", "\n", 
    "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.878007009549865*^9, 3.878007028114382*^9}, 
   3.878007875982328*^9, {3.8780079064111557`*^9, 3.878007930891727*^9}, {
   3.878008252498227*^9, 3.878008282205058*^9}, {3.878008328557969*^9, 
   3.878008329748631*^9}, {3.878008385401063*^9, 3.878008454703187*^9}, {
   3.8780085050580683`*^9, 3.878008709315185*^9}, {3.878009049572895*^9, 
   3.878009074287814*^9}, 3.878009871871427*^9, {3.878009987715438*^9, 
   3.878009989448102*^9}, {3.878010040563322*^9, 3.8780100427286663`*^9}, {
   3.8780101072505693`*^9, 3.8780101490945597`*^9}, {3.878010180487163*^9, 
   3.878010191155099*^9}, {3.8780107347261972`*^9, 3.878010737255455*^9}, {
   3.8780107850262947`*^9, 3.878010789624352*^9}, {3.878010819932063*^9, 
   3.878010885444314*^9}, {3.878010922291395*^9, 3.8780109690595007`*^9}, {
   3.8780110579224*^9, 3.878011109776705*^9}, {3.8780111447607737`*^9, 
   3.878011147028728*^9}, {3.878011225324676*^9, 3.878011229365287*^9}, {
   3.878011316637116*^9, 3.8780113230348883`*^9}, {3.878026319368355*^9, 
   3.878026366876336*^9}, 3.878026423146998*^9, {3.878026457121085*^9, 
   3.878026540876687*^9}, {3.878093854435094*^9, 3.8780938655122747`*^9}, 
   3.878093946559024*^9, {3.898150565740191*^9, 3.898150618250236*^9}, {
   3.898150658316012*^9, 3.898150774488037*^9}, {3.898150825708955*^9, 
   3.898151320009363*^9}, {3.898151377630576*^9, 3.898151402427332*^9}, {
   3.8981515072511168`*^9, 3.898151663294015*^9}, {3.8981520590707808`*^9, 
   3.89815218136338*^9}, {3.8981531471618*^9, 3.898153154465934*^9}, 
   3.898153196753481*^9, {3.8981533907549543`*^9, 3.8981534073282757`*^9}, {
   3.898153588023157*^9, 3.8981535885803022`*^9}, {3.898153697140818*^9, 
   3.898153697961557*^9}, {3.8981538145790167`*^9, 3.898153854157793*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"09ea549b-7002-4492-a532-cff36f6d4d98"]
}, Closed]],

Cell[CellGroupData[{

Cell["Spatial orbitals", "Title",
 CellChangeTimes->{{3.878007002866379*^9, 
  3.878007004763926*^9}},ExpressionUUID->"eb4dec65-f5c6-424a-8f41-\
b7e72ba22d11"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"spatialorbG0W0", "[", 
    RowBox[{
    "nBas_", ",", "nO_", ",", "nV_", ",", "\[Epsilon]_", ",", "ERI_", ",", 
     "ENuc_", ",", "ERHF_", ",", "options_", ",", "verbose_", ",", 
     "regularizerorbital_", ",", "regularizerselfenergy_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\n", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "nS", ",", "ispin", ",", "dRPA", ",", "linearquantities", ",", "sERI", 
       ",", "\[CapitalOmega]", ",", "\[CapitalSigma]x", ",", 
       "\[CapitalSigma]c", ",", "EcGM", ",", "Z", ",", "G0W0quantities", ",", 
       "EcRPA", ",", "SelfEnergyquantities", ",", "\n", " ", 
       "SelfEnergyquantities\[Omega]", ",", "eG0W0NL", ",", 
       "\[CapitalSigma]c\[Omega]", ",", "SelfEnergyquantitiesIm", ",", 
       "Re\[CapitalSigma]c", ",", "Im\[CapitalSigma]c", ",", 
       "Im\[CapitalSigma]c\[Omega]", ",", "\[Epsilon]G0W0", ",", "BSE", ",", 
       "dBSE", ",", "dTDA", ",", "\n", " ", "singlet", ",", "triplet", ",", 
       "TabG0W0", ",", "IP", ",", "\[Epsilon]G0W0lin", ",", 
       "\[Epsilon]Renorm", ",", "d\[CapitalSigma]cd\[Omega]", ",", "time", 
       ",", "lin", ",", "\[Eta]", ",", "TDA", ",", "TDAW", ",", "EcBSE", ",", 
       "XpY"}], "}"}], ",", "\n", "           ", "\n", "\n", 
     RowBox[{"(*", " ", "options", " ", "*)"}], "           ", "\n", 
     RowBox[{
      RowBox[{"lin", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<linearized\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"\[Eta]", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<\[Eta]\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"TDA", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"TDAW", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<TDA_GW\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"BSE", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<BSE\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"dBSE", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<dBSE\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"dTDA", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<dTDA\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"singlet", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<singlet\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", 
      RowBox[{"triplet", " ", "=", " ", 
       RowBox[{
       "options", "\[LeftDoubleBracket]", "\"\<triplet\>\"", 
        "\[RightDoubleBracket]"}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", "\"\<Tamm-Dancoff approximation activated!\>\"", 
            "]"}]}], "]"}], ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAW", "\[Equal]", "True"}], ",", 
           RowBox[{
           "Print", "[", 
            "\"\<Tamm-Dancoff approximation for dynamic screening!\>\"", 
            "]"}]}], "]"}], ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDA", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation activated!\>\"", "]"}]}], "]"}], 
         ";", "\n", "  ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"TDAW", "\[Equal]", "True"}], ",", 
           RowBox[{
           "PrintTemporary", "[", 
            "\"\<Tamm-Dancoff approximation for dynamic screening!\>\"", 
            "]"}]}], "]"}], ";"}]}], "\n", "]"}], ";", "\n", "           ", 
      "\n", 
      RowBox[{"nS", "=", 
       RowBox[{"nO", "*", "nV"}]}], ";", "\n", "\n", 
      RowBox[{"dRPA", "=", "True"}], ";", "\n", 
      RowBox[{"ispin", "=", "1"}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<First RPA calculation...\>\"", "]"}], 
         ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{
         "PrintTemporary", "[", "\"\<First RPA calculation...\>\"", "]"}], 
         ";"}]}], "\n", "]"}], ";", "\n", "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/LR/linear_Response.nb\>\""}], "]"}], 
      ";", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearquantities"}], "}"}], "=", 
       RowBox[{"Timing", "[", 
        RowBox[{"LinearResponse", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]", ",", "ERI", ",", 
          "TDAW", ",", "ispin", ",", "dRPA"}], "]"}], "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalOmega]", "=", 
       RowBox[{"linearquantities", "[", "\"\<\[CapitalOmega]\>\"", "]"}]}], 
      ";", "\n", 
      RowBox[{"XpY", "=", 
       RowBox[{"linearquantities", "[", "\"\<XpY\>\"", "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"NotebookEvaluate", "[", 
       RowBox[{"path", "<>", "\"\</src/GW/GW_excitation_density.nb\>\""}], 
       "]"}], ";", "\n", 
      RowBox[{"sERI", "=", 
       RowBox[{"GWExcitationDensity", "[", 
        RowBox[{"nBas", ",", "nO", ",", "nS", ",", "ERI", ",", "XpY"}], 
        "]"}]}], ";", "\n", "    ", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"Print", "[", "\"\<Done !\>\"", "]"}], ";"}], "\n", "  ", 
        ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"PrintTemporary", "[", "\"\<Done !\>\"", "]"}], ";"}]}], 
       "\n", "]"}], ";", "\n", "\t", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalized", " ", "orbital", " ", "energies"}], " ", "*)"}],
       "\n", 
      RowBox[{"\[Epsilon]Renorm", " ", "=", " ", 
       RowBox[{"\[Epsilon]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"i", "=", "1"}], "nO"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              RowBox[{"2", " ", 
               SuperscriptBox[
                RowBox[{"sERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "i", ",", "jb"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"\[Epsilon]Renorm", " ", "=", " ", 
       RowBox[{"\[Epsilon]Renorm", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              RowBox[{"2", " ", 
               SuperscriptBox[
                RowBox[{"sERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "jb"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerorbital", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"\[Epsilon]Renorm", " ", "=", " ", 
       RowBox[{"Re", "[", "\[Epsilon]Renorm", "]"}]}], ";", "\n", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Self", " ", "energy"}], " ", "*)"}], "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"jb", "=", "1"}], "nS"], 
           RowBox[{
            FractionBox[
             RowBox[{"2", " ", 
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"]}], 
             RowBox[{"\[Omega]", "-", 
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], " ", ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"\[CapitalSigma]c\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              RowBox[{"2", " ", 
               SuperscriptBox[
                RowBox[{"sERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "jb"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              RowBox[{"\[Omega]", "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", "\[CapitalSigma]c\[Omega]", "]"}]}], ";", "\n", 
      RowBox[{"\[CapitalSigma]c", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
           "\[RightDoubleBracket]"}], "/.", 
          RowBox[{"\[Omega]", "\[Rule]", 
           RowBox[{
           "\[Epsilon]Renorm", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Renormalization", " ", "factor"}], " ", "*)"}], "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"i", "=", "1"}], "nO"], 
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"jb", "=", "1"}], "nS"], 
           RowBox[{
            FractionBox[
             RowBox[{
              RowBox[{"-", "2"}], " ", 
              SuperscriptBox[
               RowBox[{"sERI", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}],
                "2"]}], 
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{"\[Omega]", "-", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
            RowBox[{"regularizerselfenergy", "[", 
             RowBox[{
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
               "\[RightDoubleBracket]"}], "-", 
              RowBox[{
              "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}], "+", 
              RowBox[{
              "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
               "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";", "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "+", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           UnderoverscriptBox["\[Sum]", 
            RowBox[{"a", "=", 
             RowBox[{"nO", "+", "1"}]}], "nBas"], 
           RowBox[{
            UnderoverscriptBox["\[Sum]", 
             RowBox[{"jb", "=", "1"}], "nS"], 
            RowBox[{
             FractionBox[
              RowBox[{
               RowBox[{"-", "2"}], " ", 
               SuperscriptBox[
                RowBox[{"sERI", "\[LeftDoubleBracket]", 
                 RowBox[{"p", ",", "a", ",", "jb"}], 
                 "\[RightDoubleBracket]"}], "2"]}], 
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{"\[Omega]", "-", 
                 RowBox[{
                 "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                  "\[RightDoubleBracket]"}], "-", 
                 RowBox[{
                 "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{"\[ImaginaryI]", "*", "\[Eta]"}]}], ")"}], "2"]], 
             RowBox[{"regularizerselfenergy", "[", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], "]"}]}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}]}], ";", "\n", 
      RowBox[{"d\[CapitalSigma]cd\[Omega]", " ", "=", " ", 
       RowBox[{"Re", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "d\[CapitalSigma]cd\[Omega]", "\[LeftDoubleBracket]", "p", 
            "\[RightDoubleBracket]"}], "/.", 
           RowBox[{"\[Omega]", "\[Rule]", 
            RowBox[{
            "\[Epsilon]Renorm", "\[LeftDoubleBracket]", "p", 
             "\[RightDoubleBracket]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}], "]"}]}], ";", "\n", 
      "\n", 
      RowBox[{"Z", " ", "=", " ", 
       FractionBox["1", 
        RowBox[{"1", "-", "d\[CapitalSigma]cd\[Omega]"}]]}], ";", "\n", "\n", 
      
      RowBox[{"(*", " ", 
       RowBox[{"Linearized", " ", "Quasiparticle", " ", "equation"}], " ", 
       "*)"}], "\n", 
      RowBox[{"\[Epsilon]G0W0lin", " ", "=", " ", 
       RowBox[{"\[Epsilon]Renorm", " ", "+", " ", 
        RowBox[{"Z", "*", "\[CapitalSigma]c"}]}]}], ";", "\n", "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lin", "\[Equal]", "True"}], ",", "\n", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by linearization !\>\"", 
             "]"}], ";"}], "\n", "    ", ",", 
           RowBox[{"(*", "else", "*)"}], "  ", "\n", "    ", 
           RowBox[{
            RowBox[{
            "PrintTemporary", "[", 
             "\"\<QP energies obtained by linearization !\>\"", "]"}], 
            ";"}]}], "\n", "  ", "]"}], ";", "\n", "  ", "\n", "  ", 
         RowBox[{"\[Epsilon]G0W0", "=", "\[Epsilon]G0W0lin"}], ";"}], ",", 
        "\n", "  ", "\n", "  ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "    ", 
           RowBox[{
            RowBox[{
            "Print", "[", "\"\<QP energies obtained by root search !\>\"", 
             "]"}], ";"}], "\n", "    ", ",", 
           RowBox[{"(*", "else", "*)"}], "\n", "    ", 
           RowBox[{
            RowBox[{
            "PrintTemporary", "[", 
             "\"\<QP energies obtained by root search !\>\"", "]"}], ";"}]}], 
          "\n", "  ", "]"}], ";", "\n", "  ", "\n", "  ", 
         RowBox[{"\[Epsilon]G0W0", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"\[Omega]", "/.", 
             RowBox[{"FindRoot", "[", 
              RowBox[{
               RowBox[{"\[Omega]", "\[Equal]", 
                RowBox[{
                 RowBox[{
                 "\[Epsilon]Renorm", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}], "+", 
                 RowBox[{
                 "\[CapitalSigma]c\[Omega]", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Omega]", ",", 
                 RowBox[{
                 "\[Epsilon]G0W0lin", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], "}"}]}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"p", ",", "nBas"}], "}"}]}], "]"}]}], ";"}]}], "\n", 
       "     ", "\n", "]"}], ";", "\n", "\t", "\n", 
      RowBox[{"(*", " ", 
       RowBox[{"Choose", " ", "the", " ", "first", " ", "IP"}], " ", "*)"}], 
      "\n", 
      RowBox[{"IP", "=", 
       RowBox[{
        RowBox[{
        "\[Epsilon]G0W0", "\[LeftDoubleBracket]", "nO", 
         "\[RightDoubleBracket]"}], "*", "HaToeV"}]}], ";", "\n", "    ", 
      "\n", 
      RowBox[{"(*", 
       RowBox[{"RPA", " ", "correlation", " ", "energy"}], "*)"}], "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<Second RPA calculation...\>\"", "]"}], 
         ";"}], "\n", "  ", ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{
         "PrintTemporary", "[", "\"\<Second RPA calculation...\>\"", "]"}], 
         ";"}]}], "\n", "]"}], ";", "\n", "\n", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"time", ",", "linearquantities"}], "}"}], "=", 
       RowBox[{"Timing", "[", 
        RowBox[{"LinearResponse", "[", 
         RowBox[{
         "nBas", ",", "nO", ",", "nV", ",", "\[Epsilon]G0W0", ",", "ERI", ",",
           "TDAW", ",", "ispin", ",", "dRPA"}], "]"}], "]"}]}], ";", "\n", 
      "    ", "\n", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", "\n", "  ", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"Print", "[", "\"\<Done !\>\"", "]"}], ";"}], "\n", "  ", 
        ",", 
        RowBox[{"(*", "else", "*)"}], "\n", "  ", 
        RowBox[{
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"\"\<CPU time (s) = \>\"", ",", "time"}], "]"}], ";", "\n", 
         "  ", 
         RowBox[{"PrintTemporary", "[", "\"\<Done !\>\"", "]"}], ";"}]}], 
       "\n", "]"}], ";", "\n", "\n", 
      RowBox[{"EcRPA", "=", 
       RowBox[{"linearquantities", "[", "\"\<Ec\>\"", "]"}]}], ";", "\n", 
      "    ", "\n", 
      RowBox[{"(*", 
       RowBox[{
       "Galitskii", " ", "Migdal", " ", "correlation", " ", "energy"}], 
       "*)"}], "\n", 
      RowBox[{"EcGM", "=", 
       RowBox[{
        UnderoverscriptBox["\[Sum]", 
         RowBox[{"i", "=", "1"}], "nO"], 
        RowBox[{
         UnderoverscriptBox["\[Sum]", 
          RowBox[{"a", "=", 
           RowBox[{"nO", "+", "1"}]}], "nBas"], 
         RowBox[{
          UnderoverscriptBox["\[Sum]", 
           RowBox[{"jb", "=", "1"}], "nS"], 
          RowBox[{"-", 
           FractionBox[
            RowBox[{"4", 
             SuperscriptBox[
              RowBox[{"sERI", "\[LeftDoubleBracket]", 
               RowBox[{"a", ",", "i", ",", "jb"}], "\[RightDoubleBracket]"}], 
              "2"], 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                "\[RightDoubleBracket]"}], "-", 
               RowBox[{
               "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}], "+", 
               RowBox[{
               "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                "\[RightDoubleBracket]"}]}], ")"}]}], 
            RowBox[{
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "a", 
                 "\[RightDoubleBracket]"}], "-", 
                RowBox[{
                "\[Epsilon]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], "+", 
                RowBox[{
                "\[CapitalOmega]", "\[LeftDoubleBracket]", "jb", 
                 "\[RightDoubleBracket]"}]}], ")"}], "2"], "+", 
             SuperscriptBox["\[Eta]", "2"]}]]}]}]}]}]}], ";", "\n", "\n", 
      RowBox[{"(*", 
       RowBox[{"Print", " ", "outputs"}], "*)"}], "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"verbose", "\[Equal]", "True"}], ",", "\n", "  ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GW/print_G0W0.nb\>\""}], "]"}], ";",
          "\n", "  ", 
         RowBox[{"Print", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<G0W0 outputs:\>\"", ",", "Bold", ",", "Red"}], "]"}], 
          "]"}], ";", "\n", "  ", 
         RowBox[{"TabG0W0", "=", 
          RowBox[{"PrintG0W0", "[", 
           RowBox[{
           "nO", ",", "\[Epsilon]", ",", "\[CapitalSigma]c", ",", "Z", ",", 
            "\[Epsilon]G0W0", ",", "ENuc", ",", "ERHF", ",", "EcRPA", ",", 
            "EcGM"}], "]"}]}], ";", "\n", "  ", 
         RowBox[{"Print", "[", "TabG0W0", "]"}], ";"}]}], "\n", "]"}], ";", 
      "\n", "    ", "\n", 
      RowBox[{"(*", 
       RowBox[{"BSE", " ", "calculation"}], "*)"}], "\n", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"BSE", "\[Equal]", "True"}], ",", "\n", "  ", 
        RowBox[{
         RowBox[{"NotebookEvaluate", "[", 
          RowBox[{"path", "<>", "\"\</src/GW/BSE.nb\>\""}], "]"}], ";", "\n", 
         "      ", "\n", "  ", 
         RowBox[{"PrintTemporary", "[", 
          RowBox[{"Style", "[", 
           RowBox[{"\"\<BSE calculation\>\"", ",", "Bold", ",", "Orange"}], 
           "]"}], "]"}], ";", "\n", "  ", 
         RowBox[{"EcBSE", " ", "=", " ", 
          RowBox[{"BetheSalpeterEquation", "[", 
           RowBox[{
           "nBas", ",", "nO", ",", "nV", ",", "nS", ",", "\[Epsilon]", ",", 
            "\[Epsilon]G0W0", ",", "ERI", ",", "TDA", ",", "TDAW", ",", 
            "dBSE", ",", "dTDA", ",", "singlet", ",", "triplet", ",", 
            "\[Eta]", ",", "verbose"}], "]"}]}], ";"}]}], "\n", "\n", "]"}], 
      ";", "\n", "    ", "\n", 
      RowBox[{"G0W0quantities", "=", 
       RowBox[{"Association", "[", 
        RowBox[{
         RowBox[{"\"\<soeG0W0\>\"", "\[Rule]", "\[Epsilon]G0W0"}], ",", 
         RowBox[{"\"\<EcGM\>\"", "\[Rule]", "EcGM"}], ",", 
         RowBox[{"\"\<EcRPA\>\"", "\[Rule]", "EcRPA"}], ",", 
         RowBox[{"\"\<Z\>\"", "\[Rule]", "Z"}], ",", 
         RowBox[{"\"\<\[CapitalSigma]c\>\"", "\[Rule]", "\[CapitalSigma]c"}], 
         ",", 
         RowBox[{
         "\"\<\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "\[CapitalSigma]c\[Omega]"}], ",", "\n", 
         "                           ", 
         RowBox[{
         "\"\<Re\[CapitalSigma]c\>\"", "\[Rule]", "Re\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\>\"", "\[Rule]", "Im\[CapitalSigma]c"}], ",", 
         RowBox[{
         "\"\<Im\[CapitalSigma]c\[Omega]\>\"", "\[Rule]", 
          "Im\[CapitalSigma]c\[Omega]"}], ",", 
         RowBox[{"\"\<IP\>\"", "\[Rule]", "IP"}]}], "]"}]}], ";", "\n", 
      "                     ", "\n", 
      RowBox[{"Return", "[", "G0W0quantities", "]"}], ";"}]}], "\n", "\n", 
    "]"}]}], ";"}]], "Code",
 CellChangeTimes->{{3.878007035024446*^9, 3.87800705016754*^9}, {
   3.878022773003071*^9, 3.87802280715771*^9}, {3.878022859776536*^9, 
   3.878023114696657*^9}, {3.8780231565588217`*^9, 3.8780231568631*^9}, {
   3.878023208299013*^9, 3.878023221267497*^9}, {3.8780244169587393`*^9, 
   3.8780244568627996`*^9}, {3.878093890891584*^9, 3.8780939368543463`*^9}, {
   3.8780942671655617`*^9, 3.8780942809275703`*^9}, {3.8783766637101517`*^9, 
   3.878376688301952*^9}, {3.878376722280335*^9, 3.878376813811689*^9}, {
   3.878377061876655*^9, 3.8783770636524467`*^9}, {3.878377114163164*^9, 
   3.878377120320161*^9}, {3.878377235043841*^9, 3.878377246329082*^9}, {
   3.878377443653675*^9, 3.878377490993145*^9}, {3.878377535951996*^9, 
   3.8783775474465523`*^9}, 3.878378366874339*^9, 3.878378426825123*^9, {
   3.878645905141382*^9, 3.878645986782605*^9}, {3.878646813480002*^9, 
   3.878646886316689*^9}, {3.881895970469026*^9, 3.881895973451735*^9}, {
   3.8818961246946707`*^9, 3.881896287541523*^9}, {3.881896468956649*^9, 
   3.881896469923648*^9}, {3.881896507331918*^9, 3.881896662807066*^9}, {
   3.8818969894526863`*^9, 3.881897115002091*^9}, 3.881897229534033*^9, {
   3.881897276153709*^9, 3.881897343556789*^9}, {3.881897483254819*^9, 
   3.881897485554097*^9}, {3.881897696024054*^9, 3.881897706947653*^9}, {
   3.881898476553924*^9, 3.881898481914933*^9}, {3.88190086212698*^9, 
   3.88190088043782*^9}, {3.89762034642957*^9, 3.897620357288115*^9}, {
   3.897620412259697*^9, 3.8976204484574213`*^9}, {3.897620487304669*^9, 
   3.897620492354907*^9}, {3.8976210613696423`*^9, 3.897621139060424*^9}, {
   3.89762123515033*^9, 3.897621271524941*^9}, {3.897621378008387*^9, 
   3.897621403860277*^9}, {3.897621505606595*^9, 3.8976215072571383`*^9}, {
   3.89762160307364*^9, 3.897621625404847*^9}, {3.897621708341964*^9, 
   3.8976217216740627`*^9}, 3.897621784678008*^9, {3.89814018921485*^9, 
   3.898140189702289*^9}, {3.89814027600991*^9, 3.898140700876367*^9}, {
   3.8981407374468737`*^9, 3.898140888892342*^9}, {3.898140932284275*^9, 
   3.898141377491658*^9}, {3.898141420851288*^9, 3.898141538681458*^9}, {
   3.898141638281797*^9, 3.8981416419596663`*^9}, {3.898141937858398*^9, 
   3.8981419446158524`*^9}, {3.8981422274281807`*^9, 3.898142314631103*^9}, {
   3.898142403175572*^9, 3.89814240409449*^9}, {3.898142447550125*^9, 
   3.898142453086865*^9}, {3.89814274819315*^9, 3.898142754270466*^9}, {
   3.898143042706428*^9, 3.898143072049934*^9}, {3.898143102856258*^9, 
   3.898143219511335*^9}, 3.898143339850004*^9, {3.8981436976840677`*^9, 
   3.898143707144558*^9}, {3.898143770809288*^9, 3.898143856207334*^9}, 
   3.8981438885324173`*^9, {3.898144038164547*^9, 3.898144227455752*^9}, {
   3.89814436438304*^9, 3.898144416166987*^9}, {3.898144471690775*^9, 
   3.89814451620497*^9}, {3.898144649835532*^9, 3.898144656834687*^9}, {
   3.898149976512694*^9, 3.898150017406135*^9}, {3.8981505005132723`*^9, 
   3.898150516607943*^9}, {3.898152082655682*^9, 3.898152083768736*^9}, {
   3.898154037713582*^9, 3.89815409946244*^9}, {3.8981541338525877`*^9, 
   3.89815413405978*^9}, {3.898154363494626*^9, 3.898154371540936*^9}, {
   3.898154786102767*^9, 3.898154792412889*^9}, {3.898158726850395*^9, 
   3.8981587311831913`*^9}, {3.89815943070679*^9, 
   3.898159431786797*^9}},ExpressionUUID->"ac580fa4-be9c-4a80-81ec-\
627a4a96e229"]
}, Open  ]]
},
WindowSize->{1272, 770},
WindowMargins->{{Automatic, -257}, {-164, Automatic}},
TaggingRules->Association["TryRealOnly" -> False],
Magnification:>1.15 Inherited,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (June 19, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"f54027fa-7cef-4bd8-af6f-c67937302bc1"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 149, 3, 113, "Title",ExpressionUUID->"7f9779b4-c01e-428c-a258-d6634f96cf06"],
Cell[732, 27, 10153, 189, 877, "Code",ExpressionUUID->"6852136e-0b70-41bd-acc9-006c0f21877f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[10922, 221, 160, 3, 113, "Title",ExpressionUUID->"005e9ac3-9f38-4b4f-a064-2192e1577188"],
Cell[11085, 226, 28968, 670, 3458, "Code",ExpressionUUID->"09ea549b-7002-4492-a532-cff36f6d4d98"]
}, Closed]],
Cell[CellGroupData[{
Cell[40090, 901, 159, 3, 82, "Title",ExpressionUUID->"eb4dec65-f5c6-424a-8f41-b7e72ba22d11"],
Cell[40252, 906, 31026, 701, 3436, "Code",ExpressionUUID->"ac580fa4-be9c-4a80-81ec-627a4a96e229"]
}, Open  ]]
}
]
*)

